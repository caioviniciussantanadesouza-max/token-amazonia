<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel Amaz√¥nia ‚Äî Token Amaz√¥nia</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">

  <style>
    :root{
      --bg:#05080f;
      --panel: rgba(6,10,18,.78);
      --line: rgba(26,255,140,.25);
      --neon:#1aff8c;
      --text:#e4e9f2;
      --muted:#9bb0d3;
    }
    *{ box-sizing:border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); }
    body { font-family: Arial, Helvetica, sans-serif; color: var(--text); }

    #map { height: 100vh; width: 100%; background: #05080f; }

    .hud{
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display:flex;
      gap:12px;
      padding:10px 14px;
      background: var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      backdrop-filter: blur(10px);
      align-items:center;
      flex-wrap: wrap;
      justify-content: center;
    }
    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border:1px solid var(--line);
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      transition:.2s;
      background: rgba(0,0,0,.25);
      font-weight:800;
      white-space:nowrap;
    }
    .chip:hover{
      border-color: rgba(26,255,140,.55);
      box-shadow:0 0 18px rgba(26,255,140,.15);
    }
    .btn{
      padding:10px 14px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(0,0,0,.25);
      color: var(--text);
      text-decoration:none;
      font-weight:900;
      transition:.2s;
      cursor:pointer;
    }
    .btn:hover{
      border-color: rgba(26,255,140,.55);
      box-shadow:0 0 18px rgba(26,255,140,.15);
    }

    .legend{
      position: fixed;
      bottom: 18px;
      left: 18px;
      z-index: 9999;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      backdrop-filter: blur(10px);
      width: 260px;
    }
    .legend h3{ margin:0 0 8px; font-size: 14px; }
    .bar{
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(90deg,
        rgba(255,60,60,.95),
        rgba(255,210,60,.95),
        rgba(26,255,140,.95)
      );
      border: 1px solid rgba(255,255,255,.08);
    }
    .legend .row{
      display:flex;
      justify-content: space-between;
      font-size: 12px;
      color: rgba(228,233,242,.80);
      margin-top: 6px;
    }

    .status{
      position: fixed;
      bottom: 18px;
      right: 18px;
      z-index: 9999;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      backdrop-filter: blur(10px);
      width: min(360px, calc(100vw - 36px));
      font-size: 12px;
      color: rgba(228,233,242,.85);
      line-height: 1.45;
    }
    .dot{
      display:inline-block;
      width:10px; height:10px;
      border-radius:50%;
      margin-right:8px;
      background: rgba(26,255,140,.95);
      box-shadow: 0 0 12px rgba(26,255,140,.35);
      vertical-align: middle;
    }

    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.75);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 10000;
    }
    .modal{
      width:min(820px, calc(100vw - 28px));
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px;
      backdrop-filter: blur(10px);
      box-shadow:0 10px 40px rgba(0,0,0,.55);
    }
    .modalTitle{ font-weight:900; font-size: 16px; }
    .modalBody{ margin-top:10px; color:#dfe7ff; line-height:1.6; }
    .muted{ color: var(--muted); }
    .close{
      float:right;
      cursor:pointer;
      font-weight:900;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
    }
    .close:hover{ border-color: rgba(26,255,140,.55); }

    ul.bullet{ padding-left:18px; }
    ul.bullet li{ margin:8px 0; }

    /* se Leaflet n√£o carregar, aparece esse aviso */
    .fallback{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      background: #05080f;
      z-index: 20000;
      padding: 24px;
      text-align:center;
    }
    .fallback .card{
      max-width: 760px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 18px;
    }

    @media (max-width:560px){
      .hud{ gap:10px; }
    }
  </style>
</head>

<body>

  <div class="hud">
    <div class="chip" onclick="openModal('oquee')">üåø O que √©</div>
    <div class="chip" onclick="openModal('comofunciona')">‚öôÔ∏è Como funciona</div>
    <div class="chip" onclick="openModal('painel')">üìä Painel</div>

    <a class="btn" href="index.html">‚¨Ö Voltar</a>
    <button class="btn" onclick="carregarDados()">‚Üª Atualizar dados</button>
  </div>

  <div id="map"></div>

  <div class="legend">
    <h3>Escala Bioecol√≥gica (0‚Äì100)</h3>
    <div class="bar"></div>
    <div class="row"><span>Baixa</span><span>M√©dia</span><span>Alta</span></div>
  </div>

  <div class="status">
    <span class="dot"></span><strong>Sistema ativo ‚Äî Amaz√¥nia</strong><br>
    Dados p√∫blicos ‚Ä¢ Atualiza√ß√£o cont√≠nua<br>
    <span class="muted" id="statusMsg">Inicializando‚Ä¶</span>
  </div>

  <div class="modalOverlay" id="modalOverlay" onclick="overlayClick(event)">
    <div class="modal">
      <div class="close" onclick="closeModal()">Fechar ‚úï</div>
      <div class="modalTitle" id="modalTitle"></div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <div class="fallback" id="fallback">
    <div class="card">
      <h2 style="margin:0 0 8px;">Erro: o mapa n√£o carregou</h2>
      <p style="margin:0 0 10px; color: rgba(228,233,242,.85); line-height:1.55;">
        O navegador n√£o conseguiu baixar a biblioteca do mapa (Leaflet).
        Isso causa o erro <strong>"L is not defined"</strong>.
      </p>
      <p style="margin:0; color: rgba(228,233,242,.75); line-height:1.55;">
        Solu√ß√£o: confirme se o arquivo <strong>painel-mapa.html</strong> foi salvo exatamente com este c√≥digo
        e recarregue a p√°gina (Ctrl+F5). Se persistir, a rede bloqueou o CDN ‚Äî a gente troca para outro.
      </p>
    </div>
  </div>

  <!-- Leaflet JS (TEM que vir ANTES do nosso script) -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    function setStatus(msg){
      document.getElementById("statusMsg").textContent = msg;
    }

    // Se Leaflet falhar, mostra aviso e N√ÉO fica branco
    if (typeof L === "undefined") {
      document.getElementById("fallback").style.display = "flex";
      throw new Error("Leaflet n√£o carregou (L is undefined).");
    }

    // MAPA sem nomes de cidades
    const map = L.map("map", { zoomControl: false, attributionControl: false });

    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png", {
      maxZoom: 19
    }).addTo(map);

    const amazonBounds = L.latLngBounds(
      L.latLng(-20.5, -79.5),
      L.latLng(  6.5, -44.0)
    );
    map.fitBounds(amazonBounds);
    map.setMaxBounds(amazonBounds.pad(0.35));
    map.on("drag", () => map.panInsideBounds(amazonBounds.pad(0.35), { animate: false }));
    L.control.zoom({ position: "bottomright" }).addTo(map);

    const layerPontos = L.layerGroup().addTo(map);

    function corPorValor(v){
      const n = Number(v);
      if (Number.isNaN(n)) return "rgba(160,170,190,.85)";
      if (n < 34) return "rgba(255,60,60,.95)";
      if (n < 67) return "rgba(255,210,60,.95)";
      return "rgba(26,255,140,.95)";
    }

    function limparPontos(){ layerPontos.clearLayers(); }

    function gerarPontosFake(qtd = 60){
      const pts = [];
      for(let i=0;i<qtd;i++){
        const lat = -18 + Math.random()*22;
        const lon = -75 + Math.random()*28;
        const bio = Math.floor(Math.random()*101);
        pts.push({ lat, lon, bio });
      }
      return { points: pts, fonte: "FAKE_LOCAL" };
    }

    async function carregarDados(){
      try{
        limparPontos();
        setStatus("Buscando dados.json‚Ä¶");

        const res = await fetch("dados.json", { cache: "no-store" });
        let data;

        if(!res.ok){
          data = gerarPontosFake(60);
          setStatus("Sem dados.json (pontos de demonstra√ß√£o).");
        } else {
          data = await res.json();
          setStatus("Dados carregados (arquivo dados.json).");
        }

        if(!data.points || !Array.isArray(data.points)){
          data = gerarPontosFake(60);
          setStatus("Formato inv√°lido (pontos de demonstra√ß√£o).");
        }

        for(const p of data.points){
          const v = (p.bio ?? p.valor ?? p.v ?? 0);
          const c = corPorValor(v);

          const marker = L.circleMarker([p.lat, p.lon], {
            radius: 7, color: c, weight: 2,
            fillColor: c, fillOpacity: 0.35
          });

          marker.bindPopup(
            `Bio: <strong>${v}</strong><br>lat: ${Number(p.lat).toFixed(4)} | lon: ${Number(p.lon).toFixed(4)}`
          );

          marker.addTo(layerPontos);

          L.circleMarker([p.lat, p.lon], {
            radius: 18, color: c, weight: 0,
            fillColor: c, fillOpacity: 0.12
          }).addTo(layerPontos);
        }

      }catch(err){
        console.error(err);
        // mostra fake mesmo em erro
        limparPontos();
        const data = gerarPontosFake(60);
        for(const p of data.points){
          const c = corPorValor(p.bio);
          L.circleMarker([p.lat, p.lon], { radius: 7, color:c, weight:2, fillColor:c, fillOpacity:0.35 }).addTo(layerPontos);
          L.circleMarker([p.lat, p.lon], { radius:18, color:c, weight:0, fillColor:c, fillOpacity:0.12 }).addTo(layerPontos);
        }
        setStatus("Erro nos dados reais (mostrando demonstra√ß√£o).");
      }
    }

    // Inicializa
    carregarDados();

    // MODAIS
    const content = {
      oquee: {
        title: "üåø O que √© o Token Amaz√¥nia",
        body: `
          <p>
            O Token Amaz√¥nia √© um projeto de transpar√™ncia ambiental que utiliza
            <strong>dados p√∫blicos de sat√©lite</strong> para monitorar, em escala continental,
            o estado ecol√≥gico da floresta amaz√¥nica.
          </p>
          <p class="muted">Este site funciona como a vitrine t√©cnica e institucional do sistema.</p>
        `
      },
      comofunciona: {
        title: "‚öôÔ∏è Como funciona",
        body: `
          <p>
            Dados do programa <strong>Sentinel-2</strong> s√£o processados continuamente por meio do
            <strong>Google Earth Engine</strong>.
          </p>
          <p class="muted">
            A partir desses dados, √© gerado um <strong>√≠ndice ecol√≥gico sint√©tico</strong> que
            representa a atividade biol√≥gica da Amaz√¥nia ao longo do tempo.
          </p>
        `
      },
      painel: {
        title: "üìä Painel Amaz√¥nia ‚Äî voc√™ encontra",
        body: `
          <ul class="bullet">
            <li><strong>Sistema ativo da Amaz√¥nia</strong></li>
            <li><strong>Dados p√∫blicos</strong></li>
            <li><strong>Atualiza√ß√£o cont√≠nua</strong></li>
          </ul>
          <p class="muted">
            Painel interativo com mapas e s√©ries temporais baseados em dados oficiais de sensoriamento remoto.
          </p>
        `
      }
    };

    function openModal(key){
      const overlay = document.getElementById("modalOverlay");
      const titleEl = document.getElementById("modalTitle");
      const bodyEl = document.getElementById("modalBody");
      const item = content[key];
      if(!item) return;
      titleEl.innerHTML = item.title;
      bodyEl.innerHTML = item.body;
      overlay.style.display = "flex";
    }
    function closeModal(){
      document.getElementById("modalOverlay").style.display = "none";
    }
    function overlayClick(e){
      if(e.target.id === "modalOverlay") closeModal();
    }
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") closeModal();
    });
  </script>

</body>
</html>
