<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel Amaz√¥nia ‚Äî Token Amaz√¥nia</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    :root{
      --bg:#05080f;
      --panel: rgba(6,10,18,.78);
      --line: rgba(26,255,140,.25);
      --neon:#1aff8c;
      --text:#e4e9f2;
      --muted:#9bb0d3;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background: radial-gradient(1200px 600px at 50% 0%, rgba(26,255,140,.08), transparent 60%),
                  var(--bg);
      color: var(--text);
    }

    /* Top HUD */
    .topHud{
      position:sticky;
      top:0;
      z-index:999;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding:14px 16px;
      background: rgba(0,0,0,.55);
      border-bottom:1px solid rgba(26,255,140,.18);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; flex-direction:column;
      line-height:1.1;
    }
    .brand .t1{ font-weight:900; letter-spacing:.2px; }
    .brand .t2{ color: rgba(228,233,242,.75); font-size:.9em; margin-top:3px; }

    .chips{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
    }
    .chip{
      border:1px solid var(--line);
      color: var(--text);
      background: rgba(0,0,0,.25);
      border-radius:999px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      transition:.2s;
      white-space:nowrap;
    }
    .chip:hover{ border-color: rgba(26,255,140,.55); box-shadow:0 0 18px rgba(26,255,140,.12); }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--line);
      color: var(--text);
      background: rgba(0,0,0,.25);
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      transition:.2s;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{ border-color: rgba(26,255,140,.55); box-shadow:0 0 18px rgba(26,255,140,.12); }

    /* Layout */
    .wrap{
      display:grid;
      grid-template-columns: 320px 1fr 320px;
      gap:14px;
      padding:14px;
    }
    .card{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      backdrop-filter: blur(10px);
      min-height: 120px;
    }
    .card h3{
      margin:0 0 10px;
      font-size:1em;
      letter-spacing:.2px;
    }
    .muted{ color: var(--muted); }

    /* MAP */
    .mapCard{
      padding:0;
      overflow:hidden;
      border-radius:18px;
    }
    #map{
      width:100%;
      height: 520px;
      background:#000;
    }
    .mapHud{
      position:absolute;
      inset:auto auto 14px 14px;
      z-index:500;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(26,255,140,.22);
      border-radius:12px;
      padding:10px 12px;
      max-width: 340px;
      backdrop-filter: blur(8px);
    }
    .mapHud .okdot{
      display:inline-block;
      width:9px; height:9px;
      border-radius:99px;
      background: var(--neon);
      margin-right:8px;
      box-shadow:0 0 12px rgba(26,255,140,.35);
    }

    /* Legend */
    .legend{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(26,255,140,.18);
      background: rgba(0,0,0,.22);
    }
    .bar{
      height:10px;
      border-radius:999px;
      background: linear-gradient(90deg,
        rgba(255,65,65,.95),
        rgba(255,200,0,.95),
        rgba(26,255,140,.95)
      );
      border:1px solid rgba(255,255,255,.08);
    }
    .legendRow{
      display:flex; justify-content:space-between;
      font-size:.82em;
      color: rgba(228,233,242,.75);
      margin-top:6px;
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px 10px;
      font-size:.92em;
    }
    .kv .k{ color: rgba(228,233,242,.75); }
    .kv .v{ font-weight:900; }

    .small{
      font-size:.85em;
      color: rgba(228,233,242,.70);
      line-height:1.5;
    }

    /* Modal */
    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.75);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      padding:14px;
    }
    .modal{
      width:min(860px, 100%);
      background: var(--panel);
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px;
      backdrop-filter: blur(10px);
      box-shadow:0 10px 40px rgba(0,0,0,.55);
    }
    .modalTop{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding-bottom:10px; border-bottom:1px solid rgba(26,255,140,.12);
    }
    .modalTitle{ font-weight:900; }
    .close{
      cursor:pointer;
      font-weight:900;
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 12px;
    }
    .close:hover{ border-color: rgba(26,255,140,.55); }
    .modalBody{ padding-top:12px; line-height:1.65; color:#dfe7ff; }
    ul.bullet{ padding-left:18px; }
    ul.bullet li{ margin:8px 0; }

    @media (max-width: 1100px){
      .wrap{ grid-template-columns: 1fr; }
      #map{ height: 520px; }
    }
  </style>
</head>

<body>
  <div class="topHud">
    <div class="brand">
      <div class="t1">PAINEL AMAZ√îNIA ‚Äî Monitoramento Bioecol√≥gico</div>
      <div class="t2">Dados p√∫blicos ‚Ä¢ Atualiza√ß√£o cont√≠nua ‚Ä¢ BioIndex (0‚Äì100)</div>
    </div>

    <div class="chips">
      <div class="chip" onclick="openModal('oquee')">üåø O que √©</div>
      <div class="chip" onclick="openModal('comofunciona')">‚öôÔ∏è Como funciona</div>
      <div class="chip" onclick="openModal('painel')">üìä Painel</div>
    </div>

    <div class="actions">
      <a class="btn" href="index.html">‚Üê Voltar</a>
      <button class="btn" id="btnAtualizar" type="button">‚Üª Atualizar</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h3>üåê Camadas P√∫blicas</h3>
      <div class="small">
        Base: Sat√©lite (mundo real)<br>
        Fonte: ESRI World Imagery (visual sat√©lite)
      </div>
      <hr style="border:none;border-top:1px solid rgba(26,255,140,.12);margin:12px 0">
      <div class="kv">
        <div class="k">Status</div><div class="v" id="stStatus">carregando‚Ä¶</div>
        <div class="k">Atualiza√ß√£o</div><div class="v" id="stUpdate">‚Äî</div>
      </div>
      <div class="small" style="margin-top:10px">
        Pontos: BioIndex calculado com <b>dados clim√°ticos p√∫blicos</b> (umidade, nuvens, precipita√ß√£o).<br>
        Pr√≥ximo passo: combinar com √≠ndice por sat√©lite (NDVI/Sentinel/GEE).
      </div>
    </div>

    <div class="card mapCard" style="position:relative">
      <div id="map"></div>

      <div class="mapHud">
        <div style="font-weight:900;margin-bottom:6px;">
          <span class="okdot"></span>Sistema ativo ‚Äî Amaz√¥nia
        </div>
        <div class="small" id="mapInfo">
          Carregando dados p√∫blicos‚Ä¶ clique nos pontos.
        </div>

        <div class="legend">
          <div style="font-weight:900; margin-bottom:6px;">Escala Bioecol√≥gica (0‚Äì100)</div>
          <div class="bar"></div>
          <div class="legendRow"><span>Perigo</span><span>Aten√ß√£o</span><span>Bom</span></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>üì° Leituras em tempo real</h3>
      <div class="kv">
        <div class="k">Pontos carregados</div><div class="v" id="stCount">‚Äî</div>
        <div class="k">√öltimo ponto</div><div class="v" id="stLast">‚Äî</div>
      </div>
      <hr style="border:none;border-top:1px solid rgba(26,255,140,.12);margin:12px 0">
      <div class="small">
        Clique em um ponto no mapa para ver:
        <b>Umidade</b>, <b>Nuvens</b>, <b>Precipita√ß√£o</b> e o <b>BioIndex</b>.
      </div>
    </div>

    <div class="card">
      <h3>üß™ S√©rie temporal (MVP)</h3>
      <div class="small">
        Placeholder do gr√°fico temporal.<br>
        Depois colocamos a s√©rie real (por sat√©lite / API).
      </div>
    </div>

    <div class="card">
      <h3>üß© Integridade / Cobertura</h3>
      <div class="small">
        Placeholder de camadas reais (desmatamento, fogo, rios, etc.).<br>
        Depois conectamos fontes oficiais.
      </div>
    </div>

    <div class="card">
      <h3>üîí Transpar√™ncia</h3>
      <div class="small">
        Token Amaz√¥nia ‚Äî Transpar√™ncia ambiental baseada em dados p√∫blicos.<br>
        Este projeto n√£o constitui oferta de investimento. Plataforma de monitoramento ambiental.
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modalOverlay" id="modalOverlay" onclick="overlayClick(event)">
    <div class="modal">
      <div class="modalTop">
        <div class="modalTitle" id="modalTitle"></div>
        <div class="close" onclick="closeModal()">Fechar ‚úï</div>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ====== MAPA ======
    const map = L.map("map", { zoomControl: true }).setView([-6.0, -60.0], 4);

    // Sat√©lite sem r√≥tulos
    L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 18, attribution: "Esri" }
    ).addTo(map);

    const layerPontos = L.layerGroup().addTo(map);

    // ====== CORES (verde bom, amarelo aten√ß√£o, vermelho perigo) ======
    function corPorValor(valor){
      const v = Number(valor);
      if (Number.isNaN(v)) return "rgba(180,190,210,.9)";

      // perigo (0‚Äì39)
      if (v < 40) return "rgba(255,65,65,.95)";
      // aten√ß√£o (40‚Äì69)
      if (v < 70) return "rgba(255,200,0,.95)";
      // bom (70‚Äì100)
      return "rgba(26,255,140,.95)";
    }

    // ====== BIOINDEX (0‚Äì100) COM DADOS REAIS (Open-Meteo) ======
    // Regras simples (MVP):
    // - mais umidade e mais nuvens tendem a favorecer "atividade" (no conceito)
    // - precipita√ß√£o conta forte (at√© 5mm/h j√° pesa bastante)
    function calcBioIndex(hum, cloud, precip){
      const h = Math.max(0, Math.min(100, Number(hum)));
      const c = Math.max(0, Math.min(100, Number(cloud)));
      const p = Math.max(0, Number(precip));

      // normaliza precip: 0mm => 0 | 5mm+ => 100
      const pNorm = Math.max(0, Math.min(100, (p / 5) * 100));

      // pesos (ajuste fino depois)
      const bio = (0.45 * h) + (0.25 * c) + (0.30 * pNorm);
      return Math.round(Math.max(0, Math.min(100, bio)));
    }

    async function getDadosReais(lat, lon){
      // Open-Meteo (sem chave)
      const url = "https://api.open-meteo.com/v1/forecast"
        + "?latitude=" + encodeURIComponent(lat)
        + "&longitude=" + encodeURIComponent(lon)
        + "&current=relative_humidity_2m,precipitation,cloud_cover"
        + "&timezone=auto";

      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error("Falha Open-Meteo: " + res.status);

      const j = await res.json();
      if(!j.current) throw new Error("Open-Meteo sem campo current");

      return {
        humidity: j.current.relative_humidity_2m,
        precipitation: j.current.precipitation,
        cloud: j.current.cloud_cover,
        time: j.current.time
      };
    }

    function limparPontos(){
      layerPontos.clearLayers();
    }

    async function carregarDados(){
      document.getElementById("stStatus").textContent = "carregando‚Ä¶";
      document.getElementById("mapInfo").textContent = "Carregando dados p√∫blicos‚Ä¶";
      document.getElementById("stLast").textContent = "‚Äî";
      document.getElementById("stCount").textContent = "‚Äî";

      limparPontos();

      const res = await fetch("dados.json", { cache: "no-store" });
      if(!res.ok) throw new Error("N√£o achei dados.json (erro " + res.status + ")");
      const data = await res.json();

      const pts = data.points || [];
      document.getElementById("stCount").textContent = String(pts.length);

      // carrega um por um (simples e confi√°vel)
      for(const p of pts){
        const lat = p.lat, lon = p.lon, nome = p.nome || "Ponto";

        let real;
        try{
          real = await getDadosReais(lat, lon);
        }catch(e){
          // Se der erro, marca como cinza e avisa no popup
          const marker = L.circleMarker([lat, lon], {
            radius: 7,
            color: "rgba(180,190,210,.9)",
            weight: 2,
            fillColor: "rgba(180,190,210,.9)",
            fillOpacity: 0.35
          }).addTo(layerPontos);

          marker.bindPopup(
            `<strong>${nome}</strong><br>
             Falha ao buscar dados reais.<br>
             <span class="muted">${e.message}</span>`
          );

          continue;
        }

        const bio = calcBioIndex(real.humidity, real.cloud, real.precipitation);
        const c = corPorValor(bio);

        // Ponto
        const marker = L.circleMarker([lat, lon], {
          radius: 7,
          color: c,
          weight: 2,
          fillColor: c,
          fillOpacity: 0.40
        }).addTo(layerPontos);

        // Halo HUD
        L.circleMarker([lat, lon], {
          radius: 18,
          color: c,
          weight: 0,
          fillColor: c,
          fillOpacity: 0.12
        }).addTo(layerPontos);

        marker.on("click", () => {
          document.getElementById("stLast").textContent = nome;
        });

        marker.bindPopup(
          `<strong>${nome}</strong><br><br>
           <b>BioIndex:</b> <span style="color:${c}">${bio}</span> / 100<br>
           <b>Umidade:</b> ${real.humidity}%<br>
           <b>Nuvens:</b> ${real.cloud}%<br>
           <b>Precipita√ß√£o:</b> ${real.precipitation} mm<br>
           <span class="muted">Hor√°rio local: ${real.time}</span><br>
           <span class="muted">lat: ${lat} | lon: ${lon}</span>`
        );

        document.getElementById("stUpdate").textContent = new Date().toLocaleString();
      }

      document.getElementById("stStatus").textContent = "online";
      document.getElementById("mapInfo").textContent = "Dados p√∫blicos carregados. Clique nos pontos.";
    }

    // ====== MODAIS ======
    const content = {
      oquee: {
        title: "üåø O que √© o Token Amaz√¥nia",
        body: `
          <p>
            O Token Amaz√¥nia √© um projeto de transpar√™ncia ambiental que utiliza
            <strong>dados p√∫blicos</strong> para monitorar, em escala continental,
            o estado ecol√≥gico da floresta amaz√¥nica.
          </p>
          <p class="muted">
            Este painel √© a prova visual do sistema em funcionamento.
          </p>
        `
      },
      comofunciona: {
        title: "‚öôÔ∏è Como funciona",
        body: `
          <p>
            Este painel integra camadas p√∫blicas (clima, sat√©lite, √≠ndices) para formar um
            <strong>BioIndex (0‚Äì100)</strong>.
          </p>
          <p class="muted">
            Hoje: BioIndex derivado de dados clim√°ticos p√∫blicos em tempo real (umidade, nuvens e precipita√ß√£o).
            Pr√≥ximo passo: substituir/combinar com √≠ndice por sat√©lite (NDVI/Sentinel/GEE).
          </p>
        `
      },
      painel: {
        title: "üìä Painel Amaz√¥nia ‚Äî voc√™ encontra",
        body: `
          <ul class="bullet">
            <li><strong>Sistema ativo da Amaz√¥nia</strong></li>
            <li><strong>Dados p√∫blicos</strong></li>
            <li><strong>Atualiza√ß√£o cont√≠nua</strong></li>
          </ul>
          <p class="muted">
            Mapa sat√©lite real + pontos com leitura p√∫blica. Clique nos pontos para ver os dados usados no √≠ndice.
          </p>
        `
      }
    };

    function openModal(key){
      const overlay = document.getElementById("modalOverlay");
      const titleEl = document.getElementById("modalTitle");
      const bodyEl = document.getElementById("modalBody");
      const item = content[key];
      if(!item) return;
      titleEl.innerHTML = item.title;
      bodyEl.innerHTML = item.body;
      overlay.style.display = "flex";
    }
    function closeModal(){ document.getElementById("modalOverlay").style.display = "none"; }
    function overlayClick(e){ if(e.target.id === "modalOverlay") closeModal(); }
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

    // ====== Atualiza√ß√£o ======
    async function atualizarTudo(){
      try{
        await carregarDados();
      }catch(err){
        alert("Erro: " + err.message);
        document.getElementById("stStatus").textContent = "erro";
      }
    }

    document.getElementById("btnAtualizar").addEventListener("click", atualizarTudo);

    // Inicializa
    atualizarTudo();

    // Auto (10 min)
    setInterval(atualizarTudo, 10 * 60 * 1000);
  </script>
</body>
</html>
