async function carregarDados(){
  // Monta a URL correta (mesma pasta do painel, mesmo no GitHub Pages)
  const basePath = location.href.substring(0, location.href.lastIndexOf("/") + 1);
  const url = basePath + "fires.json?ts=" + Date.now();

  // HUD
  document.getElementById("stStatus").textContent = "carregando…";

  const r = await fetch(url, { cache: "no-store" });
  if(!r.ok){
    const msg = `Falha ao carregar fires.json (${r.status}). URL: ${url}`;
    document.getElementById("stStatus").textContent = "erro";
    throw new Error(msg);
  }

  const j = await r.json();
  const points = (j.points || []).map(p => ({
    ...p,
    level: p.level || "green"
  }));

  // Stats
  let g=0,y=0,rr=0;
  for(const p of points){
    if(p.level==="red") rr++;
    else if(p.level==="yellow") y++;
    else g++;
  }
  document.getElementById("nGreen").textContent = g;
  document.getElementById("nYellow").textContent = y;
  document.getElementById("nRed").textContent = rr;

  document.getElementById("stTime").textContent =
    j.updated_at ? new Date(j.updated_at).toLocaleString("pt-BR") : "—";

  document.getElementById("stStatus").textContent = "ativo";

  // GeoJSON
  const geojson = {
    type: "FeatureCollection",
    features: points.map(p => ({
      type: "Feature",
      properties: p,
      geometry: { type: "Point", coordinates: [p.lon, p.lat] }
    }))
  };

  // Atualiza se já existe
  if(map.getSource("fires")){
    map.getSource("fires").setData(geojson);
    return;
  }

  // Cria source/layer (primeira vez)
  map.addSource("fires", { type: "geojson", data: geojson });

  map.addLayer({
    id: "fires-layer",
    type: "circle",
    source: "fires",
    paint: {
      "circle-radius": ["interpolate", ["linear"], ["zoom"], 3.5, 2, 7, 4, 10, 7],
      "circle-color": [
        "match",
        ["get","level"],
        "green", "#38E27D",
        "yellow", "#FFD84D",
        "red", "#FF4D4D",
        "#FFFFFF"
      ],
      "circle-opacity": 0.85,
      "circle-stroke-width": 1,
      "circle-stroke-color": "rgba(0,0,0,0.55)"
    }
  });

  map.on("mouseenter","fires-layer",()=> map.getCanvas().style.cursor="pointer");
  map.on("mouseleave","fires-layer",()=> map.getCanvas().style.cursor="");

  map.on("click","fires-layer",(e)=>{
    const f = e.features && e.features[0];
    if(!f) return;
    const p = f.properties;

    const html = `
      <div style="font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px; line-height:1.35;">
        <div><b>Estado:</b> <span style="color:${levelColor(p.level)}">${p.level}</span></div>
        <div><b>Confiança:</b> ${p.confidence ?? "-"}</div>
        <div><b>Brilho:</b> ${p.brightness ?? "-"}</div>
        <div style="opacity:.8;margin-top:6px;">Fonte: NASA FIRMS</div>
      </div>
    `;
    new mapboxgl.Popup({ closeButton:true })
      .setLngLat(e.lngLat)
      .setHTML(html)
      .addTo(map);
  });
}
