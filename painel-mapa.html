<script>
  // === CAMADAS ===
  const layerPontos = L.layerGroup().addTo(map);

  // === CORES POR BIO (0-100) ===
  function corPorValor(v){
    const n = Number(v);
    if (Number.isNaN(n)) return "rgba(120,140,180,.85)"; // fallback neutro

    if (n < 30) return "rgba(255,60,60,.95)";      // vermelho (baixo)
    if (n < 60) return "rgba(255,200,40,.95)";     // amarelo (médio)
    return "rgba(26,255,140,.95)";                 // verde (alto)
  }

  function limparPontos(){
    layerPontos.clearLayers();
  }

  // === DESENHO A (TORRE) ===
  function desenharTorre(lat, lon, c, p){
    // núcleo forte
    const marker = L.circleMarker([lat, lon], {
      radius: 10,
      color: c,
      weight: 2,
      fillColor: c,
      fillOpacity: 0.55
    });

    // halo grande HUD
    L.circleMarker([lat, lon], {
      radius: 26,
      color: c,
      weight: 0,
      fillColor: c,
      fillOpacity: 0.16
    }).addTo(layerPontos);

    // segundo halo (mais sutil)
    L.circleMarker([lat, lon], {
      radius: 42,
      color: c,
      weight: 0,
      fillColor: c,
      fillOpacity: 0.08
    }).addTo(layerPontos);

    // “pilar” (anel vertical fake: vários círculos pequenos subindo)
    // (efeito visual simples, sem 3D de verdade)
    for(let i=1;i<=4;i++){
      L.circleMarker([lat + (i*0.03), lon], {
        radius: 5 - i*0.6,
        color: c,
        weight: 1,
        fillColor: c,
        fillOpacity: 0.22
      }).addTo(layerPontos);
    }

    // popup ambiental (sem cidade)
    marker.bindPopup(popupAmbiental(p));

    marker.addTo(layerPontos);
  }

  // === DESENHO B (GRADE) ===
  function desenharGrade(lat, lon, c, p){
    // ponto pequeno
    const marker = L.circleMarker([lat, lon], {
      radius: 5,
      color: c,
      weight: 1.5,
      fillColor: c,
      fillOpacity: 0.30
    });

    // halo pequeno
    L.circleMarker([lat, lon], {
      radius: 14,
      color: c,
      weight: 0,
      fillColor: c,
      fillOpacity: 0.10
    }).addTo(layerPontos);

    marker.bindPopup(popupAmbiental(p));
    marker.addTo(layerPontos);
  }

  // === POPUP (SEM CIDADE, SEM NOME) ===
  function popupAmbiental(p){
    const bio = safeNum(p.bio);
    const co2 = safeNum(p.co2);
    const agua = safeNum(p.agua);
    const integridade = safeNum(p.integridade);
    const vegetacao = safeNum(p.vegetacao);

    return `
      <div style="font-weight:900;margin-bottom:6px;">Ponto de leitura — Amazônia</div>
      <div>BioÍndice: <strong>${bio}</strong> / 100</div>
      <div>CO₂ (proxy): <strong>${co2}</strong></div>
      <div>Regulação hídrica: <strong>${agua}</strong></div>
      <div>Integridade ecológica: <strong>${integridade}</strong></div>
      <div>Vegetação (proxy NDVI/EVI): <strong>${vegetacao}</strong></div>
      <div style="margin-top:6px;opacity:.75;font-size:12px;">
        lat: ${Number(p.lat).toFixed(4)} | lon: ${Number(p.lon).toFixed(4)}
      </div>
    `;
  }

  function safeNum(v){
    const n = Number(v);
    if(Number.isNaN(n)) return "—";
    // arredonda bonito
    return Math.round(n * 10) / 10;
  }

  // === CARREGAR DADOS ===
  async function carregarDados(){
    try{
      limparPontos();

      const res = await fetch("dados.json", { cache: "no-store" });
      if(!res.ok) throw new Error("Não achei dados.json (erro " + res.status + ")");
      const data = await res.json();

      // 1) B (grade) primeiro (fica “por baixo”)
      // 2) A (torres) por cima (destaque)
      const pontosB = [];
      const pontosA = [];

      for(const p of data.points){
        // sem cidade/sem nome — ignorar se vier
        const bio = Number(p.bio);

        // regra de tipo:
        // - se p.tipo existir ("A" ou "B"), respeita
        // - senão: bio >= 70 vira torre (A), resto grade (B)
        const tipo = (p.tipo === "A" || p.tipo === "B")
          ? p.tipo
          : (bio >= 70 ? "A" : "B");

        if(tipo === "A") pontosA.push(p);
        else pontosB.push(p);
      }

      // desenha B
      for(const p of pontosB){
        const c = corPorValor(p.bio);
        desenharGrade(p.lat, p.lon, c, p);
      }

      // desenha A
      for(const p of pontosA){
        const c = corPorValor(p.bio);
        desenharTorre(p.lat, p.lon, c, p);
      }

    }catch(err){
      alert("Erro ao carregar dados: " + err.message);
    }
  }

  // Carrega ao abrir a página
  carregarDados();
</script>
