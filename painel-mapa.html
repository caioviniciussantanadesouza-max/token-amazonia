<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel ‚Äî Observat√≥rio Bioecol√≥gico da Amaz√¥nia</title>

  <!-- Leaflet (MAPA) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg:#05080f;
      --panel: rgba(6,10,18,.82);
      --line: rgba(26,255,140,.25);
      --neon:#1aff8c;
      --text:#e4e9f2;
      --muted:#9bb0d3;
      --warn:#ffd54a;
      --bad:#ff4a4a;
      --good:#1aff8c;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background: radial-gradient(1200px 600px at 50% 0%, rgba(30,60,120,.25), transparent 60%), var(--bg);
      color: var(--text);
      overflow:hidden;
    }

    /* ===== TOP BAR ===== */
    .topbar{
      position:fixed;
      top:14px; left:14px; right:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      z-index:9999;
    }
    .brand{
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--panel);
      backdrop-filter: blur(10px);
      font-weight:900;
      letter-spacing:.3px;
      display:flex; gap:10px; align-items:center;
      min-width: 280px;
    }
    .brand small{ display:block; font-weight:700; color:rgba(228,233,242,.75); margin-top:2px; letter-spacing:0; }
    .chips{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:16px;
      background:var(--panel);
      backdrop-filter: blur(10px);
    }
    .chip{
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      color: var(--text);
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      display:flex; gap:8px; align-items:center;
      transition:.18s;
      white-space:nowrap;
    }
    .chip:hover{
      border-color: rgba(26,255,140,.55);
      box-shadow:0 0 18px rgba(26,255,140,.15);
    }
    .actions{
      display:flex; gap:10px; align-items:center;
    }
    .btn{
      border:1px solid var(--line);
      background: var(--panel);
      color: var(--text);
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      backdrop-filter: blur(10px);
      transition:.18s;
      white-space:nowrap;
      text-decoration:none;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{
      border-color: rgba(26,255,140,.55);
      box-shadow:0 0 18px rgba(26,255,140,.15);
    }

    /* ===== LAYOUT GRID (HUD) ===== */
    .grid{
      position:fixed;
      top:70px; left:14px; right:14px; bottom:14px;
      display:grid;
      grid-template-columns: 320px 1fr 320px;
      grid-template-rows: 1fr 170px;
      gap:14px;
      z-index:1;
    }
    .panel{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius:18px;
      backdrop-filter: blur(10px);
      overflow:hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,.45);
    }
    .panel .hd{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:900;
    }
    .panel .bd{
      padding:12px 14px;
      color: rgba(228,233,242,.88);
      font-size:.95em;
      line-height:1.55;
    }
    .muted{ color: var(--muted); }

    /* ===== MAP ===== */
    .mapWrap{
      position:relative;
    }
    #map{
      width:100%;
      height:100%;
      background:#0b0f18;
    }
    .mapHUD{
      position:absolute;
      left:14px; top:14px;
      z-index:500;
      border:1px solid var(--line);
      background: rgba(6,10,18,.70);
      border-radius:14px;
      padding:10px 12px;
      max-width: 290px;
      backdrop-filter: blur(10px);
    }
    .dot{
      width:9px;height:9px;border-radius:999px;display:inline-block;margin-right:8px;
      background: var(--good);
      box-shadow:0 0 12px rgba(26,255,140,.45);
    }
    .legend{
      position:absolute;
      left:14px; bottom:14px;
      z-index:500;
      border:1px solid var(--line);
      background: rgba(6,10,18,.70);
      border-radius:14px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
      width: 300px;
    }
    .bar{
      height:10px;
      border-radius:999px;
      background: linear-gradient(90deg, var(--bad), var(--warn), var(--good));
      border:1px solid rgba(255,255,255,.08);
      margin:8px 0 6px;
    }
    .barLabels{
      display:flex; justify-content:space-between;
      font-size:.85em; color: rgba(228,233,242,.78);
    }

    /* Bottom cards */
    .bottom{
      grid-column: 1 / 4;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:14px;
    }

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.75);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99999;
    }
    .modal{
      width:min(860px, calc(100vw - 28px));
      background: var(--panel);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px 16px 14px;
      backdrop-filter: blur(10px);
      box-shadow:0 10px 40px rgba(0,0,0,.55);
    }
    .modalTitle{ font-weight:900; font-size:1.1em; }
    .close{
      float:right;
      cursor:pointer;
      font-weight:900;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
    }
    .close:hover{ border-color: rgba(26,255,140,.55); }
    ul.bullet{ padding-left:18px; }
    ul.bullet li{ margin:8px 0; }

    @media (max-width: 1100px){
      body{ overflow:auto; }
      .grid{
        position:relative;
        top:70px;
        height:auto;
        grid-template-columns: 1fr;
        grid-template-rows: auto;
      }
      .bottom{ grid-template-columns: 1fr; }
      #map{ height: 60vh; }
    }
  </style>
</head>

<body>

  <div class="topbar">
    <div class="brand">
      PAINEL AMAZ√îNIA ‚Äî Observat√≥rio Bioecol√≥gico
      <small id="subBrand">Dados p√∫blicos ‚Ä¢ Atualiza√ß√£o cont√≠nua ‚Ä¢ Escala 0‚Äì100</small>
    </div>

    <div class="chips">
      <div class="chip" onclick="openModal('oquee')">üåø <span>O que √©</span></div>
      <div class="chip" onclick="openModal('comofunciona')">‚öôÔ∏è <span>Como funciona</span></div>
      <div class="chip" onclick="openModal('painel')">üìä <span>Painel</span></div>
    </div>

    <div class="actions">
      <a class="btn" href="index.html">‚Üê Voltar</a>
      <button class="btn" onclick="atualizarTudo()">‚Üª Atualizar</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="panel">
      <div class="hd">üóÇÔ∏è Camadas P√∫blicas <span class="muted" id="statusOnline">online</span></div>
      <div class="bd" id="camadasTxt">
        Base: Sat√©lite (NASA GIBS)<br>
        Overlay: NDVI (vegeta√ß√£o) + Anomalias t√©rmicas (fogo)<br><br>
        <b>Pontos (reais)</b><br>
        Eventos p√∫blicos de inc√™ndio (EONET), filtrados pela regi√£o amaz√¥nica.
        <div class="muted" style="margin-top:10px" id="atualizacao">Atualiza√ß√£o: ‚Äî</div>
      </div>
    </div>

    <!-- CENTER MAP -->
    <div class="panel mapWrap">
      <div id="map"></div>

      <div class="mapHUD" id="mapHUD">
        <div><span class="dot"></span><b>Sistema ativo ‚Äî Amaz√¥nia</b></div>
        <div class="muted" style="margin-top:6px">
          Clique nos pontos para ver a leitura e o motivo da cor.
        </div>
      </div>

      <div class="legend">
        <b>√çndice Ecol√≥gico Amaz√¥nico (0‚Äì100)</b>
        <div class="bar"></div>
        <div class="barLabels">
          <span>üî¥ impacto</span><span>üü° alerta</span><span>üü¢ baixo dist√∫rbio</span>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="panel">
      <div class="hd">üì° Leituras em tempo real <span class="muted" id="qtdPontos">0 pontos</span></div>
      <div class="bd">
        <b>Resumo</b><br>
        Pontos = eventos p√∫blicos (wildfires). Cor = regra simples (MVP).
        <hr style="border:0;border-top:1px solid rgba(255,255,255,.06); margin:12px 0;">
        <b>√öltimo ponto selecionado</b>
        <div class="muted" id="lastPoint">‚Äî</div>
      </div>
    </div>

    <!-- BOTTOM CARDS -->
    <div class="bottom">
      <div class="panel">
        <div class="hd">üìà S√©rie temporal (MVP) <span class="muted">placeholder</span></div>
        <div class="bd muted">
          Pr√≥ximo passo: gr√°fico real do √≠ndice por dia/semana (NDVI + fogo + clima).
        </div>
      </div>

      <div class="panel">
        <div class="hd">üß¨ Integridade / Cobertura <span class="muted">placeholder</span></div>
        <div class="bd muted">
          Pr√≥ximo passo: m√©tricas reais por sat√©lite (NDVI/biomassa) e mudan√ßas de cobertura.
        </div>
      </div>

      <div class="panel">
        <div class="hd">üîí Transpar√™ncia <span class="muted">legal</span></div>
        <div class="bd">
          Observat√≥rio Amaz√¥nia ‚Äî Transpar√™ncia ambiental baseada em dados p√∫blicos.<br>
          <span class="muted">Este projeto n√£o constitui oferta de investimento. Plataforma de monitoramento ambiental.</span>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modalOverlay" id="modalOverlay" onclick="overlayClick(event)">
    <div class="modal">
      <div class="close" onclick="closeModal()">Fechar ‚úï</div>
      <div class="modalTitle" id="modalTitle"></div>
      <div id="modalBody" style="margin-top:10px; line-height:1.6;"></div>
    </div>
  </div>

  <script>
    // ===== Helpers =====
    function hojeISO(){
      const d = new Date();
      const y = d.getUTCFullYear();
      const m = String(d.getUTCMonth()+1).padStart(2,'0');
      const day = String(d.getUTCDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    // Regra MVP de cor (voc√™ pode mudar depois com ci√™ncia melhor):
    // 0‚Äì39 vermelho, 40‚Äì69 amarelo, 70‚Äì100 verde
    function corPorValor(v){
      if(v <= 39) return getComputedStyle(document.documentElement).getPropertyValue('--bad').trim();
      if(v <= 69) return getComputedStyle(document.documentElement).getPropertyValue('--warn').trim();
      return getComputedStyle(document.documentElement).getPropertyValue('--good').trim();
    }

    // ===== MAPA =====
    const map = L.map('map', {
      zoomControl: true,
      attributionControl: true
    }).setView([-5.5, -60.0], 4);

    // NASA GIBS (tile REST) ‚Äî exemplo oficial de uso com Leaflet :contentReference[oaicite:2]{index=2}
    const TIME = hojeISO(); // hoje (UTC)
    const gibsBase = L.tileLayer(
      `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_CorrectedReflectance_TrueColor/default/${TIME}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg`,
      { maxZoom: 9, opacity: 1.0 }
    ).addTo(map);

    const gibsNDVI = L.tileLayer(
      `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_NDVI_8Day/default/${TIME}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png`,
      { maxZoom: 9, opacity: 0.35 }
    );

    const gibsThermal = L.tileLayer(
      `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_SNPP_Thermal_Anomalies_375m_All/default/${TIME}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png`,
      { maxZoom: 9, opacity: 0.55 }
    );

    const overlays = {
      "NDVI (vegeta√ß√£o)": gibsNDVI,
      "Anomalias t√©rmicas (fogo)": gibsThermal
    };
    L.control.layers({ "Sat√©lite (GIBS)": gibsBase }, overlays, { collapsed: true }).addTo(map);

    // Camadas ligadas por padr√£o (HUD visual)
    gibsNDVI.addTo(map);
    gibsThermal.addTo(map);

    // ===== PONTOS REAIS (EONET) =====
    const layerPontos = L.layerGroup().addTo(map);

    function limparPontos(){ layerPontos.clearLayers(); }

    // Bounding box ‚Äúgrande Amaz√¥nia‚Äù (MVP). Ajustamos depois.
    const AMAZON_BBOX = { minLat: -20, maxLat: 8, minLon: -80, maxLon: -44 };

    function dentroAmazonia(lat, lon){
      return lat >= AMAZON_BBOX.minLat && lat <= AMAZON_BBOX.maxLat &&
             lon >= AMAZON_BBOX.minLon && lon <= AMAZON_BBOX.maxLon;
    }

    // Converte pontos reais -> um "valor" (MVP)
    // Quanto mais recente e mais ‚Äúforte‚Äù (se tiver), pior. Aqui √© simples:
    // - se evento √© de hoje/ontem: tende a vermelho
    // - se mais antigo: amarelo/verde
    function valorMVPporData(isoDate){
      if(!isoDate) return 55;
      const t = new Date(isoDate).getTime();
      const now = Date.now();
      const diffDias = (now - t) / (1000*60*60*24);
      if(diffDias <= 2) return 25;      // vermelho
      if(diffDias <= 7) return 55;      // amarelo
      return 80;                         // verde
    }

    async function carregarPontosEONET(){
      limparPontos();

      // EONET v3 (NASA) 
      const url = "https://eonet.gsfc.nasa.gov/api/v3/events?category=wildfires&status=open&limit=200";
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("Falha ao buscar EONET: " + res.status);

      const data = await res.json();
      const eventos = data.events || [];
      let total = 0;

      for(const ev of eventos){
        // Geometrias podem ser Point/Polygon
        const geoms = ev.geometry || [];
        for(const g of geoms){
          if(!g || !g.coordinates) continue;

          // Se for Point: [lon, lat]
          if(g.type === "Point"){
            const lon = g.coordinates[0];
            const lat = g.coordinates[1];
            if(!dentroAmazonia(lat, lon)) continue;

            total++;
            const v = valorMVPporData(g.date);
            const c = corPorValor(v);

            const marker = L.circleMarker([lat, lon], {
              radius: 6,
              color: c,
              weight: 2,
              fillColor: c,
              fillOpacity: 0.60
            });

            marker.on("click", ()=>{
              document.getElementById("lastPoint").innerHTML =
                `<b>${ev.title || "Evento"}</b><br>` +
                `<span class="muted">Fonte: NASA EONET ‚Ä¢ Categoria: Wildfires</span><br>` +
                `Cor (MVP): <b>${v<=39?"üî¥ impacto":v<=69?"üü° alerta":"üü¢ baixo dist√∫rbio"}</b><br>` +
                `Data: <b>${g.date || "-"}</b><br>` +
                `Lat: ${lat.toFixed(3)} | Lon: ${lon.toFixed(3)}`;
            });

            marker.bindPopup(
              `<b>${ev.title || "Wildfire"}</b><br>`+
              `<span class="muted">EONET ‚Ä¢ ${g.date || ""}</span><br>`+
              `Classifica√ß√£o (MVP): <b>${v<=39?"üî¥ impacto":v<=69?"üü° alerta":"üü¢ baixo dist√∫rbio"}</b>`
            );

            marker.addTo(layerPontos);

            // Halo HUD
            L.circleMarker([lat, lon], {
              radius: 16,
              color: c,
              weight: 0,
              fillColor: c,
              fillOpacity: 0.18
            }).addTo(layerPontos);
          }
        }
      }

      document.getElementById("qtdPontos").textContent = `${total} pontos`;
      return total;
    }

    // ===== Atualiza√ß√£o =====
    async function atualizarTudo(){
      try{
        document.getElementById("statusOnline").textContent = "online";
        document.getElementById("atualizacao").textContent =
          "Atualiza√ß√£o: " + new Date().toLocaleString("pt-BR");

        const total = await carregarPontosEONET();

        if(total === 0){
          document.getElementById("mapHUD").innerHTML =
            `<div><span class="dot"></span><b>Sistema ativo ‚Äî Amaz√¥nia</b></div>
             <div class="muted" style="margin-top:6px">
              Nenhum ponto de wildfire retornou na √°rea (ou o limite do EONET n√£o pegou eventos agora).
             </div>`;
        }
      }catch(err){
        document.getElementById("statusOnline").textContent = "erro";
        alert("Erro ao atualizar: " + err.message);
      }
    }

    // ===== MODAIS =====
    const content = {
      oquee: {
        title: "üåø O que √© o Observat√≥rio Bioecol√≥gico da Amaz√¥nia",
        body: `
          <p>
            Um painel p√∫blico que transforma <b>dados ambientais reais</b> em uma leitura visual do
            estado ecol√≥gico da floresta.
          </p>
          <p class="muted">
            Sem pre√ßo, sem promessa, sem venda: apenas monitoramento verific√°vel.
          </p>
        `
      },
      comofunciona: {
        title: "‚öôÔ∏è Como funciona (MVP)",
        body: `
          <ul class="bullet">
            <li><b>Sat√©lite real</b> (NASA GIBS) como base do mapa.</li>
            <li><b>Vegeta√ß√£o</b> (NDVI) como camada bi√≥tica.</li>
            <li><b>Dist√∫rbios</b> (anomalias t√©rmicas) como sinal de fogo.</li>
            <li><b>Pontos reais</b> de inc√™ndio via NASA EONET.</li>
          </ul>
          <p class="muted">
            O c√°lculo ‚Äúverde/amarelo/vermelho‚Äù aqui √© MVP e ser√° refinado para virar um √≠ndice cient√≠fico robusto.
          </p>
        `
      },
      painel: {
        title: "üìä Painel Amaz√¥nia ‚Äî voc√™ encontra",
        body: `
          <ul class="bullet">
            <li><b>Sistema ativo da Amaz√¥nia</b></li>
            <li><b>Dados p√∫blicos</b></li>
            <li><b>Atualiza√ß√£o cont√≠nua</b></li>
          </ul>
          <p class="muted">
            Mapa sat√©lite real + camadas (NDVI / fogo) + pontos p√∫blicos. Clique nos pontos para ver a leitura.
          </p>
        `
      }
    };

    function openModal(key){
      const overlay = document.getElementById("modalOverlay");
      const titleEl = document.getElementById("modalTitle");
      const bodyEl = document.getElementById("modalBody");
      const item = content[key];
      if(!item) return;
      titleEl.innerHTML = item.title;
      bodyEl.innerHTML = item.body;
      overlay.style.display = "flex";
    }
    function closeModal(){
      document.getElementById("modalOverlay").style.display = "none";
    }
    function overlayClick(e){
      if(e.target.id === "modalOverlay") closeModal();
    }
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") closeModal();
    });

    // Inicializa
    atualizarTudo();
    // Atualiza autom√°tico (10 min)
    setInterval(atualizarTudo, 10 * 60 * 1000);
  </script>
</body>
</html>
