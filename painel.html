<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PAINEL AMAZ√îNIA ‚Äî Observat√≥rio Bioecol√≥gico</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#05080f;
      --panel: rgba(6,10,18,.78);
      --panel2: rgba(6,10,18,.66);
      --line: rgba(26,255,140,.25);
      --line2: rgba(26,255,140,.16);
      --neon:#1aff8c;
      --text:#e4e9f2;
      --muted:#9bb0d3;
      --warn:#ffd24a;
      --bad:#ff4d4d;
      --ok:#1aff8c;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow:hidden;
    }

    /* ===== TOP BAR ===== */
    .topbar{
      height:64px;
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 14px;
      border-bottom:1px solid rgba(15,31,58,.6);
      background: linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.25));
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border:1px solid var(--line2);
      border-radius:14px;
      background: var(--panel2);
      backdrop-filter: blur(8px);
      font-weight:900;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .brand small{
      font-weight:700;
      color: rgba(228,233,242,.72);
      margin-left:10px;
    }
    .chips{
      display:flex;
      gap:10px;
      margin-left:auto;
      margin-right:auto;
      padding:8px 10px;
      border:1px solid var(--line2);
      border-radius:16px;
      background: var(--panel2);
      backdrop-filter: blur(8px);
    }
    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border:1px solid var(--line2);
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      transition:.18s;
      background: rgba(0,0,0,.25);
      font-weight:900;
      white-space:nowrap;
    }
    .chip:hover{
      border-color: rgba(26,255,140,.55);
      box-shadow:0 0 18px rgba(26,255,140,.14);
    }
    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      margin-left:auto;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border:1px solid var(--line2);
      border-radius:999px;
      background: rgba(0,0,0,.25);
      color: var(--text);
      cursor:pointer;
      font-weight:900;
      transition:.18s;
      text-decoration:none;
    }
    .btn:hover{ border-color: rgba(26,255,140,.55); }
    .btnPrimary{
      border-color: rgba(26,255,140,.55);
      color: var(--neon);
    }
    .btnPrimary:hover{
      background: rgba(26,255,140,.10);
      box-shadow:0 0 18px rgba(26,255,140,.12);
    }

    /* ===== LAYOUT GRID ===== */
    .wrap{
      height: calc(100% - 64px);
      display:grid;
      grid-template-columns: 290px 1fr 330px;
      grid-template-rows: 1fr 150px;
      gap:12px;
      padding:12px;
    }

    .panel{
      border:1px solid var(--line2);
      border-radius:16px;
      background: var(--panel);
      backdrop-filter: blur(8px);
      overflow:hidden;
    }
    .panelHeader{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(26,255,140,.10);
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panelHeader small{
      font-weight:700;
      color: rgba(228,233,242,.72);
    }
    .panelBody{
      padding:12px;
      color: rgba(228,233,242,.92);
      font-size:.95em;
      line-height:1.4;
    }
    .muted{ color: var(--muted); }
    .kv{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:6px 0;
      border-bottom:1px dashed rgba(26,255,140,.10);
      font-size:.92em;
    }
    .kv:last-child{ border-bottom:none; }

    /* ===== MAP ===== */
    #map{
      width:100%;
      height:100%;
      border-radius:16px;
    }
    .mapWrap{
      position:relative;
      overflow:hidden;
    }
    .mapHud{
      position:absolute;
      left:14px;
      top:14px;
      z-index:500;
      max-width: 420px;
      border:1px solid var(--line2);
      border-radius:14px;
      background: rgba(6,10,18,.68);
      backdrop-filter: blur(10px);
      padding:10px 12px;
      box-shadow:0 10px 30px rgba(0,0,0,.45);
      font-size:.92em;
      line-height:1.35;
    }
    .mapHud b{ font-weight:900; }
    .legendBar{
      position:absolute;
      left:14px;
      bottom:14px;
      z-index:500;
      width: 280px;
      border:1px solid var(--line2);
      border-radius:14px;
      background: rgba(6,10,18,.68);
      backdrop-filter: blur(10px);
      padding:10px 12px;
      font-size:.9em;
    }
    .bar{
      height:10px;
      border-radius:999px;
      background: linear-gradient(90deg, var(--bad), var(--warn), var(--ok));
      margin:8px 0 6px;
      opacity:.95;
    }
    .barMeta{
      display:flex;
      justify-content:space-between;
      color: rgba(228,233,242,.72);
      font-size:.85em;
    }
    .indexBig{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
    }
    .indexBig .n{
      font-size:1.25em;
      font-weight:900;
    }

    /* Bottom cards */
    .bottomGrid{
      grid-column: 1 / 4;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid rgba(26,255,140,.18);
      border-radius:999px;
      background: rgba(0,0,0,.18);
      color: rgba(228,233,242,.90);
      font-weight:900;
      font-size:.85em;
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:999px; display:inline-block;
    }

    /* Controls in left panel */
    .controlRow{
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid rgba(26,255,140,.10);
    }
    input[type="range"]{ width:100%; }

    /* Leaflet look */
    .leaflet-control-attribution{
      background: rgba(0,0,0,.35) !important;
      color: rgba(228,233,242,.75) !important;
      border-radius:10px;
      padding:3px 8px !important;
      border:1px solid rgba(26,255,140,.12);
    }

    /* ===== MODAL ===== */
    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.76);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .modal{
      width:min(860px, calc(100vw - 28px));
      background: rgba(6,10,18,.88);
      border:1px solid rgba(26,255,140,.22);
      border-radius:18px;
      padding:16px;
      backdrop-filter: blur(10px);
      box-shadow:0 10px 40px rgba(0,0,0,.55);
    }
    .modalTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .modalTitle{
      font-weight:900;
      letter-spacing:.3px;
      font-size:1.1em;
    }
    .close{
      cursor:pointer;
      font-weight:900;
      border:1px solid rgba(26,255,140,.22);
      border-radius:999px;
      padding:6px 10px;
    }
    .close:hover{ border-color: rgba(26,255,140,.55); }
    .modalBody{
      color:#dfe7ff;
      line-height:1.6;
      font-size:.98em;
    }
    ul.bullet{ padding-left:18px; margin:8px 0; }
    ul.bullet li{ margin:8px 0; }

    /* Responsive */
    @media (max-width: 1100px){
      body{ overflow:auto; }
      .wrap{
        height:auto;
        grid-template-columns: 1fr;
        grid-template-rows: auto;
      }
      .bottomGrid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      PAINEL AMAZ√îNIA ‚Äî Observat√≥rio Bioecol√≥gico
      <small id="topHint">Dados p√∫blicos ‚Ä¢ Atualiza√ß√£o cont√≠nua ‚Ä¢ Escala 0‚Äì100</small>
    </div>

    <div class="chips">
      <div class="chip" onclick="openModal('oquee')">üåø O que √©</div>
      <div class="chip" onclick="openModal('comofunciona')">‚öôÔ∏è Como funciona</div>
      <div class="chip" onclick="openModal('painel')">üìä Painel</div>
      <div class="chip" onclick="toggleNDVI()">üå± NDVI</div>
    </div>

    <div class="actions">
      <a class="btn" href="index.html">‚Üê Voltar</a>
      <button class="btn btnPrimary" onclick="atualizarTudo()">‚ü≥ Atualizar</button>
    </div>
  </div>

  <div class="wrap">
    <!-- LEFT -->
    <div class="panel">
      <div class="panelHeader">
        <div>üß© Camadas P√∫blicas</div>
        <small><span id="statusOnline">online</span></small>
      </div>
      <div class="panelBody">
        <div class="kv"><span>Base</span><span class="muted">Sat√©lite (NASA GIBS / VIIRS)</span></div>
        <div class="kv"><span>Vegeta√ß√£o</span><span class="muted">NDVI (NASA GIBS) <b id="ndviState">off</b></span></div>
        <div class="kv"><span>Dist√∫rbio</span><span class="muted">Inc√™ndios (NASA EONET)</span></div>

        <div class="controlRow">
          <div class="badge">Regra:</div>
          <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">
            <div class="badge"><span class="dot" style="background:var(--ok)"></span>üü¢ sem dist√∫rbio</div>
            <div class="badge"><span class="dot" style="background:var(--warn)"></span>üü° alerta</div>
            <div class="badge"><span class="dot" style="background:var(--bad)"></span>üî¥ dist√∫rbio (evento real)</div>
          </div>
        </div>

        <div class="controlRow">
          <div class="kv"><span>Atualiza√ß√£o</span><span class="muted" id="lastUpdate">‚Äî</span></div>
          <div class="kv"><span>Eventos (Amaz√¥nia)</span><span class="muted" id="countEvents">‚Äî</span></div>
          <div class="kv"><span>Pixels desenhados</span><span class="muted" id="countPixels">‚Äî</span></div>
        </div>

        <div class="controlRow">
          <div class="badge">Densidade (pixel)</div>
          <small class="muted">Maior = mais detalhado (pode pesar). Recomendado 5‚Äì7.</small>
          <input id="density" type="range" min="4" max="10" step="1" value="6" />
          <div class="kv"><span>step</span><span class="muted"><b id="densityVal">6</b></span></div>
        </div>

        <div class="controlRow">
          <div class="badge">√çndice Ecol√≥gico Amaz√¥nico (0‚Äì100) ‚Äî MVP</div>
          <div class="kv"><span>Valor</span><span class="muted"><b id="bioIndex">‚Äî</b></span></div>
          <small class="muted">MVP: √≠ndice derivado de propor√ß√£o de pixels üî¥/üü° (dist√¢ncia a dist√∫rbios reais EONET).</small>
        </div>
      </div>
    </div>

    <!-- MAP CENTER -->
    <div class="panel mapWrap">
      <div id="map"></div>

      <div class="mapHud">
        <b>Sistema ativo ‚Äî Amaz√¥nia</b><br/>
        <span class="muted">Pixels hologr√°ficos dentro do bioma (geojson) + dist√∫rbio real (EONET).</span><br/>
        <span class="muted">Clique em um pixel para ver classifica√ß√£o e dist√¢ncia do dist√∫rbio.</span>
      </div>

      <div class="legendBar">
        <div class="indexBig">
          <div><b>Escala Ecol√≥gica (0‚Äì100)</b></div>
          <div class="n"><span id="bioIndex2">‚Äî</span></div>
        </div>
        <div class="bar"></div>
        <div class="barMeta">
          <span>impacto</span><span>alerta</span><span>baixo dist√∫rbio</span>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="panel">
      <div class="panelHeader">
        <div>üì° Leituras em tempo real</div>
        <small><span id="rightCount">‚Äî</span> pixels</small>
      </div>
      <div class="panelBody">
        <div class="muted">Clique em um pixel para ver classifica√ß√£o e dist√¢ncia do dist√∫rbio real.</div>
        <div style="margin-top:12px; border-top:1px dashed rgba(26,255,140,.12); padding-top:12px;">
          <div class="badge">√öltimo pixel selecionado</div>
          <div style="margin-top:10px;" id="selectedInfo" class="muted">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- BOTTOM -->
    <div class="bottomGrid">
      <div class="panel">
        <div class="panelHeader">
          <div>üìà S√©rie temporal (MVP)</div>
          <small class="muted">placeholder</small>
        </div>
        <div class="panelBody muted">
          Pr√≥ximo passo: gr√°fico real do √≠ndice por dia/semana (NDVI + fogo + anomalias + clima).
        </div>
      </div>

      <div class="panel">
        <div class="panelHeader">
          <div>üß¨ Integridade / Cobertura</div>
          <small class="muted">placeholder</small>
        </div>
        <div class="panelBody muted">
          Pr√≥ximo passo: m√©tricas reais por sat√©lite (NDVI/biomassa) e mudan√ßas de cobertura.
        </div>
      </div>

      <div class="panel">
        <div class="panelHeader">
          <div>üîí Transpar√™ncia</div>
          <small class="muted">jur√≠dico</small>
        </div>
        <div class="panelBody">
          <b>Observat√≥rio Amaz√¥nia</b> ‚Äî Transpar√™ncia ambiental baseada em dados p√∫blicos.<br/>
          <span class="muted">Este projeto n√£o constitui oferta de investimento. Plataforma de monitoramento ambiental.</span>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modalOverlay" id="modalOverlay" onclick="overlayClick(event)">
    <div class="modal">
      <div class="modalTop">
        <div class="modalTitle" id="modalTitle"></div>
        <div class="close" onclick="closeModal()">Fechar ‚úï</div>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ======= CONFIG =======
    // Mant√©m acento -> URL codificada
    const GEOJSON_URL = "amaz%C3%B4nia.geojson";

    // EONET wildfires endpoint (p√∫blico)
    const EONET_WILDFIRES =
      "https://eonet.gsfc.nasa.gov/api/v3/events?category=wildfires&status=open,closed&limit=400";

    // Limites de classifica√ß√£o por dist√¢ncia ao dist√∫rbio real
    // (ajuste fino depois; no MVP funciona bem)
    const DIST_RED_KM = 35;   // dist√∫rbio
    const DIST_YEL_KM = 90;   // alerta

    // ======= MAP INIT =======
    const map = L.map("map", {
      zoomControl: true,
      preferCanvas: true,
      worldCopyJump: true
    }).setView([-6.5, -60.0], 4);

    // Base sat√©lite (NASA GIBS VIIRS)
    const viirs = L.tileLayer(
      "https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_SNPP_CorrectedReflectance_TrueColor/default/{time}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg",
      {
        time: new Date().toISOString().slice(0,10),
        maxZoom: 9,
        attribution: "NASA GIBS (VIIRS)"
      }
    ).addTo(map);

    // NDVI real toggle (MODIS) ‚Äî 16 dias
    const ndviLayer = L.tileLayer(
      "https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_NDVI_16Day/default/{time}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png",
      {
        time: new Date().toISOString().slice(0,10),
        maxZoom: 9,
        opacity: 0.55,
        attribution: "NASA GIBS (MODIS NDVI)"
      }
    );

    let ndviOn = false;
    function toggleNDVI(){
      ndviOn = !ndviOn;
      document.getElementById("ndviState").textContent = ndviOn ? "on" : "off";
      if(ndviOn) ndviLayer.addTo(map);
      else map.removeLayer(ndviLayer);
    }

    // Layers
    const canvasRenderer = L.canvas({ padding: 0.5 });
    const layerPixels = L.layerGroup().addTo(map);
    const layerDisturb = L.layerGroup().addTo(map);
    const layerBiome = L.geoJSON(null, {
      style: {
        color: "rgba(26,255,140,.55)",
        weight: 2,
        fillOpacity: 0
      }
    }).addTo(map);

    // ======= UTILS =======
    function nowBR(){
      const d = new Date();
      return d.toLocaleString("pt-BR");
    }

    function haversineKm(lat1, lon1, lat2, lon2){
      const R = 6371;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a =
        Math.sin(dLat/2)**2 +
        Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    function corPorDistKm(d){
      if(d <= DIST_RED_KM) return { c:"rgba(255,77,77,.95)", label:"dist√∫rbio" };
      if(d <= DIST_YEL_KM) return { c:"rgba(255,210,74,.95)", label:"alerta" };
      return { c:"rgba(26,255,140,.95)", label:"sem dist√∫rbio" };
    }

    // Point in polygon (ray casting) - suporta Polygon e MultiPolygon
    function pointInRing(pt, ring){
      const x = pt[0], y = pt[1];
      let inside = false;
      for(let i=0, j=ring.length-1; i<ring.length; j=i++){
        const xi = ring[i][0], yi = ring[i][1];
        const xj = ring[j][0], yj = ring[j][1];
        const intersect = ((yi > y) !== (yj > y)) &&
          (x < (xj - xi) * (y - yi) / ((yj - yi) || 1e-12) + xi);
        if(intersect) inside = !inside;
      }
      return inside;
    }

    function pointInPolygon(lon, lat, geom){
      // pt = [lon, lat]
      const pt = [lon, lat];

      if(geom.type === "Polygon"){
        const rings = geom.coordinates;
        if(!pointInRing(pt, rings[0])) return false;
        // holes
        for(let k=1;k<rings.length;k++){
          if(pointInRing(pt, rings[k])) return false;
        }
        return true;
      }

      if(geom.type === "MultiPolygon"){
        for(const poly of geom.coordinates){
          const rings = poly;
          if(pointInRing(pt, rings[0])){
            let inHole = false;
            for(let k=1;k<rings.length;k++){
              if(pointInRing(pt, rings[k])){ inHole = true; break; }
            }
            if(!inHole) return true;
          }
        }
        return false;
      }

      return false;
    }

    function getBBoxFromGeoJSON(geo){
      let minLon= 999, minLat= 999, maxLon=-999, maxLat=-999;

      const scan = (coords) => {
        for(const c of coords){
          if(typeof c[0] === "number"){
            const lon = c[0], lat = c[1];
            minLon = Math.min(minLon, lon);
            minLat = Math.min(minLat, lat);
            maxLon = Math.max(maxLon, lon);
            maxLat = Math.max(maxLat, lat);
          }else{
            scan(c);
          }
        }
      };

      for(const f of geo.features){
        scan(f.geometry.coordinates);
      }
      return { minLon, minLat, maxLon, maxLat };
    }

    function limparLayers(){
      layerPixels.clearLayers();
      layerDisturb.clearLayers();
    }

    // ======= DATA LOAD =======
    let biomeGeo = null;
    let biomeGeom = null;
    let bbox = null;
    let events = []; // {lat, lon, timeISO}

    async function carregarBiome(){
      const res = await fetch(GEOJSON_URL, { cache:"no-store" });
      if(!res.ok) throw new Error("N√£o achei o arquivo amaz√¥nia.geojson (verifique nome/acentos). Erro: " + res.status);
      biomeGeo = await res.json();
      layerBiome.clearLayers();
      layerBiome.addData(biomeGeo);

      // usa a 1¬™ feature como m√°scara principal
      const f0 = biomeGeo.features[0];
      biomeGeom = f0.geometry;

      bbox = getBBoxFromGeoJSON(biomeGeo);
      map.fitBounds(layerBiome.getBounds(), { padding:[20,20] });
    }

    async function carregarEONET(){
      const res = await fetch(EONET_WILDFIRES, { cache:"no-store" });
      if(!res.ok) throw new Error("Falha ao buscar EONET (erro " + res.status + ")");

      const data = await res.json();
      const out = [];

      for(const ev of (data.events || [])){
        const t = ev.geometry?.[0]?.date || null;
        // pega a posi√ß√£o mais recente
        const g = ev.geometry?.[ev.geometry.length - 1];
        if(!g || g.type !== "Point") continue;
        const lon = g.coordinates[0];
        const lat = g.coordinates[1];

        // filtra por bbox do bioma (r√°pido)
        if(bbox){
          if(lon < bbox.minLon || lon > bbox.maxLon || lat < bbox.minLat || lat > bbox.maxLat) continue;
        }
        // filtra por dentro do bioma (preciso)
        if(biomeGeom && !pointInPolygon(lon, lat, biomeGeom)) continue;

        out.push({ lat, lon, timeISO: t || "" });
      }

      events = out;

      // desenha eventos como ‚Äúglow‚Äù discreto (n√£o cidade)
      layerDisturb.clearLayers();
      for(const e of events){
        const c = "rgba(255,77,77,.8)";
        L.circleMarker([e.lat, e.lon], {
          renderer: canvasRenderer,
          radius: 5,
          color: c,
          weight: 0,
          fillColor: c,
          fillOpacity: 0.55
        }).addTo(layerDisturb);

        L.circleMarker([e.lat, e.lon], {
          renderer: canvasRenderer,
          radius: 14,
          color: c,
          weight: 0,
          fillColor: c,
          fillOpacity: 0.10
        }).addTo(layerDisturb);
      }
    }

    // ======= PIXEL GRID RENDER =======
    function stepDegFromSlider(){
      const v = parseInt(document.getElementById("density").value, 10);
      document.getElementById("densityVal").textContent = v;

      // v=4 => mais denso | v=10 => menos denso
      // converte para graus aproximados
      // (esses n√∫meros d√£o ‚Äúcara de HUD‚Äù sem virar mancha)
      const mapZoom = map.getZoom();
      const base = 0.55 - (v-4)*0.05; // 0.55 .. 0.25
      const zoomFactor = Math.max(0.75, 4 / Math.max(3, mapZoom)); // ajusta quando d√° zoom
      return Math.max(0.18, base * zoomFactor);
    }

    function desenharPixels(){
      if(!biomeGeom || !bbox) return;

      layerPixels.clearLayers();

      const step = stepDegFromSlider();

      // gera grade em bbox
      let pts = [];
      for(let lat = bbox.minLat; lat <= bbox.maxLat; lat += step){
        for(let lon = bbox.minLon; lon <= bbox.maxLon; lon += step){
          if(pointInPolygon(lon, lat, biomeGeom)){
            pts.push({lat, lon});
          }
        }
      }

      // evita ‚Äúmancha‚Äù pesada: limita e amostra
      const MAX = 5200;
      if(pts.length > MAX){
        const stride = Math.ceil(pts.length / MAX);
        pts = pts.filter((_,i)=> i % stride === 0);
      }

      // classifica por dist√¢ncia ao dist√∫rbio real mais pr√≥ximo
      let red=0, yel=0, grn=0;

      for(const p of pts){
        let minD = Infinity;
        for(const e of events){
          const d = haversineKm(p.lat, p.lon, e.lat, e.lon);
          if(d < minD) minD = d;
        }
        if(events.length === 0) minD = Infinity;

        const cls = corPorDistKm(minD);
        if(cls.label === "dist√∫rbio") red++;
        else if(cls.label === "alerta") yel++;
        else grn++;

        // bolinha HUD (pequena) + halo
        const radius = 3.6;

        const marker = L.circleMarker([p.lat, p.lon], {
          renderer: canvasRenderer,
          radius,
          color: cls.c,
          weight: 0,
          fillColor: cls.c,
          fillOpacity: 0.85
        });

        marker.on("click", ()=>{
          const distTxt = (minD === Infinity) ? "‚Äî" : (minD.toFixed(1) + " km");
          document.getElementById("selectedInfo").innerHTML = `
            <div><b>Classifica√ß√£o:</b> ${cls.label}</div>
            <div><b>Dist√¢ncia do dist√∫rbio mais pr√≥ximo:</b> ${distTxt}</div>
            <div class="muted">Lat: ${p.lat.toFixed(3)} | Lon: ${p.lon.toFixed(3)}</div>
          `;
        });

        marker.addTo(layerPixels);

        L.circleMarker([p.lat, p.lon], {
          renderer: canvasRenderer,
          radius: 10,
          color: cls.c,
          weight: 0,
          fillColor: cls.c,
          fillOpacity: 0.10
        }).addTo(layerPixels);
      }

      // atualiza contadores e √≠ndice
      const total = red + yel + grn;
      document.getElementById("countPixels").textContent = total.toLocaleString("pt-BR");
      document.getElementById("rightCount").textContent = total.toLocaleString("pt-BR");

      // √≠ndice MVP (peso forte para vermelho)
      let idx = 100;
      if(total > 0){
        const redPct = red / total;
        const yelPct = yel / total;
        idx = Math.round(100 - (redPct*80 + yelPct*35) * 100);
        idx = Math.max(0, Math.min(100, idx));
      }

      document.getElementById("bioIndex").textContent = idx;
      document.getElementById("bioIndex2").textContent = idx;
    }

    // ======= MAIN UPDATE =======
    async function atualizarTudo(){
      try{
        document.getElementById("statusOnline").textContent = "online";
        document.getElementById("lastUpdate").textContent = nowBR();

        // garante bioma carregado
        if(!biomeGeo) await carregarBiome();

        // eventos reais
        await carregarEONET();
        document.getElementById("countEvents").textContent = events.length.toLocaleString("pt-BR");

        // pixels
        desenharPixels();
      }catch(err){
        document.getElementById("statusOnline").textContent = "erro";
        alert("Erro ao atualizar: " + err.message);
        console.error(err);
      }
    }

    // redraw ao mexer no zoom e na densidade
    map.on("zoomend", ()=> desenharPixels());
    document.getElementById("density").addEventListener("input", ()=> desenharPixels());

    // ===== MODAIS =====
    const content = {
      oquee: {
        title: "üåø O que √© o Observat√≥rio Bioecol√≥gico da Amaz√¥nia",
        body: `
          <p>
            Um painel p√∫blico que transforma <b>dados ambientais reais</b> em uma leitura visual do
            estado ecol√≥gico da floresta.
          </p>
          <p class="muted">
            Sem pre√ßo, sem promessa, sem venda: apenas monitoramento verific√°vel.
          </p>
        `
      },
      comofunciona: {
        title: "‚öôÔ∏è Como funciona (MVP)",
        body: `
          <ul class="bullet">
            <li><b>Sat√©lite real</b> (NASA GIBS / VIIRS) como base do mapa.</li>
            <li><b>Vegeta√ß√£o</b> (NDVI) como camada bi√≥tica <span class="muted">(j√° dispon√≠vel no toggle üå±)</span>.</li>
            <li><b>Dist√∫rbios</b> (inc√™ndios) via <b>NASA EONET</b> <span class="muted">(eventos reais)</span>.</li>
            <li><b>Pixels</b> dentro do bioma (geojson): cada ponto √© uma leitura visual.</li>
          </ul>
          <p class="muted">
            Regra do Observat√≥rio: <b>dist√∫rbio</b> = üî¥ ‚Ä¢ <b>alerta</b> = üü° ‚Ä¢ <b>sem dist√∫rbio</b> = üü¢.
            No MVP atual, a cor √© definida pela <b>dist√¢ncia ao dist√∫rbio real</b> mais pr√≥ximo (EONET).
          </p>
        `
      },
      painel: {
        title: "üìä Painel Amaz√¥nia ‚Äî voc√™ encontra",
        body: `
          <ul class="bullet">
            <li><b>Sistema ativo da Amaz√¥nia</b></li>
            <li><b>Dados p√∫blicos</b></li>
            <li><b>Atualiza√ß√£o cont√≠nua</b></li>
          </ul>
          <p class="muted">
            Mapa sat√©lite real + NDVI + dist√∫rbios reais (EONET) + pixels hologr√°ficos dentro do bioma. Clique em um pixel.
          </p>
        `
      }
    };

    function openModal(key){
      const overlay = document.getElementById("modalOverlay");
      const titleEl = document.getElementById("modalTitle");
      const bodyEl = document.getElementById("modalBody");
      const item = content[key];
      if(!item) return;
      titleEl.innerHTML = item.title;
      bodyEl.innerHTML = item.body;
      overlay.style.display = "flex";
    }
    function closeModal(){ document.getElementById("modalOverlay").style.display = "none"; }
    function overlayClick(e){ if(e.target.id === "modalOverlay") closeModal(); }
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

    // start
    atualizarTudo();
    setInterval(atualizarTudo, 10 * 60 * 1000);
  </script>
</body>
</html>
