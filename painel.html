<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PAINEL AMAZ√îNIA ‚Äî Observat√≥rio Bioecol√≥gico</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Turf (para recorte e point-in-polygon) -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#05080f;
      --panel: rgba(6,10,18,.86);
      --line: rgba(26,255,140,.22);
      --neon:#1aff8c;
      --text:#e4e9f2;
      --muted:#9bb0d3;

      --green: rgba(26,255,140,.95);
      --yellow: rgba(255,214,102,.95);
      --red: rgba(255,84,84,.95);
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow:hidden;
    }

    /* ======= HUD Layout ======= */
    .topbar{
      height:58px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 14px;
      background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.15));
      border-bottom:1px solid rgba(15,31,58,.55);
    }
    .topbar .title{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      background: var(--panel);
      border:1px solid var(--line);
      backdrop-filter: blur(10px);
      font-weight:900;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .topbar .title small{
      font-weight:600;
      color: rgba(228,233,242,.75);
      margin-left:8px;
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border:1px solid var(--line);
      border-radius:999px;
      background: var(--panel);
      cursor:pointer;
      user-select:none;
      font-weight:800;
      transition:.2s;
      backdrop-filter: blur(10px);
      white-space:nowrap;
    }
    .chip:hover{
      border-color: rgba(26,255,140,.55);
      box-shadow: 0 0 18px rgba(26,255,140,.12);
    }
    .chip.primary{
      border-color: rgba(26,255,140,.45);
      color: var(--neon);
    }

    .main{
      height: calc(100vh - 58px);
      display:grid;
      grid-template-columns: 280px 1fr 320px;
      gap:12px;
      padding:12px;
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .panel h3{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      color: rgba(228,233,242,.95);
    }
    .panel h3 span{
      color: rgba(155,176,211,.9);
      font-weight:700;
      font-size:12px;
    }
    .muted{color: var(--muted);}
    .divider{
      height:1px;
      background: rgba(26,255,140,.12);
      margin:10px 0;
    }

    /* Map card */
    .mapWrap{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(26,255,140,.18);
      box-shadow: 0 0 35px rgba(26,255,140,.08) inset;
    }
    #map{
      width:100%;
      height:100%;
      min-height: 420px;
    }

    .mapHUD{
      position:absolute;
      left:14px;
      top:14px;
      z-index:500;
      width:min(360px, calc(100% - 28px));
      background: rgba(6,10,18,.82);
      border:1px solid rgba(26,255,140,.22);
      border-radius:14px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 18px rgba(26,255,140,.08);
    }
    .mapHUD .big{
      font-weight:900;
      margin-bottom:4px;
    }
    .mapHUD .small{
      font-size:12px;
      color: rgba(228,233,242,.7);
    }

    .legend{
      position:absolute;
      left:14px;
      bottom:14px;
      z-index:500;
      width: 270px;
      background: rgba(6,10,18,.82);
      border:1px solid rgba(26,255,140,.22);
      border-radius:14px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
    }
    .legend .bar{
      margin-top:8px;
      height:10px;
      border-radius:99px;
      background: linear-gradient(90deg, rgba(255,84,84,.95), rgba(255,214,102,.95), rgba(26,255,140,.95));
    }
    .legend .labels{
      display:flex;
      justify-content:space-between;
      font-size:11px;
      margin-top:6px;
      color: rgba(228,233,242,.75);
    }

    /* Bottom panels */
    .bottom{
      grid-column: 1 / 4;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
    }

    /* Holographic dots (Leaflet circle marker style handled in JS) */
    .kpi{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      font-size:12px;
      color: rgba(228,233,242,.85);
      line-height:1.55;
    }

    .dot{
      display:inline-block;
      width:10px;height:10px;border-radius:999px;
      margin-right:8px;
      box-shadow:0 0 12px rgba(26,255,140,.35);
    }
    .dot.g{background: var(--green);}
    .dot.y{background: var(--yellow); box-shadow:0 0 12px rgba(255,214,102,.35);}
    .dot.r{background: var(--red); box-shadow:0 0 12px rgba(255,84,84,.35);}

    /* Modal */
    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.75);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .modal{
      width:min(860px, calc(100vw - 28px));
      background: rgba(6,10,18,.92);
      border:1px solid rgba(26,255,140,.22);
      border-radius:18px;
      padding:18px;
      backdrop-filter: blur(12px);
      box-shadow: 0 10px 45px rgba(0,0,0,.55);
    }
    .modalTitle{
      font-weight:900;
      letter-spacing:.2px;
      margin-bottom:8px;
    }
    .close{
      float:right;
      cursor:pointer;
      font-weight:900;
      border:1px solid rgba(26,255,140,.22);
      border-radius:999px;
      padding:6px 10px;
      color: rgba(228,233,242,.92);
    }
    .close:hover{ border-color: rgba(26,255,140,.55); }

    ul.bullet{ padding-left:18px; margin:8px 0 0; }
    ul.bullet li{ margin:8px 0; }

    @media (max-width: 980px){
      body{ overflow:auto; }
      .main{
        height:auto;
        grid-template-columns: 1fr;
      }
      .bottom{ grid-template-columns: 1fr; grid-column: 1; }
      #map{ height: 62vh; }
    }
  </style>
</head>

<body>

  <!-- Topbar -->
  <div class="topbar">
    <div class="title">
      PAINEL AMAZ√îNIA ‚Äî Observat√≥rio Bioecol√≥gico
      <small>Dados p√∫blicos ‚Ä¢ Atualiza√ß√£o cont√≠nua ‚Ä¢ Escala 0‚Äì100</small>
    </div>

    <div class="top-actions">
      <div class="chip" onclick="openModal('oquee')">üåø O que √©</div>
      <div class="chip" onclick="openModal('comofunciona')">‚öôÔ∏è Como funciona</div>
      <div class="chip" onclick="openModal('painel')">üìä Painel</div>

      <div class="chip" onclick="voltar()">‚Üê Voltar</div>
      <div class="chip primary" onclick="atualizarTudo()">‚ü≥ Atualizar</div>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <!-- Left -->
    <div class="panel">
      <h3>üß© Camadas P√∫blicas <span id="statusOnline">online</span></h3>

      <div class="kpi">
        <div><b>Base:</b> Sat√©lite (NASA GIBS / VIIRS)</div>
        <div><b>Pontos (reais):</b> Inc√™ndios (NASA EONET)</div>
      </div>

      <div class="divider"></div>

      <div class="kpi">
        <div><b>Regra:</b></div>
        <div><span class="dot g"></span>üü¢ sem dist√∫rbio</div>
        <div><span class="dot y"></span>üü° alerta</div>
        <div><span class="dot r"></span>üî¥ dist√∫rbio (evento real)</div>
      </div>

      <div class="divider"></div>

      <div class="kpi">
        <div><b>Atualiza√ß√£o:</b> <span id="txtAtualizacao">‚Äî</span></div>
        <div><b>Eventos carregados:</b> <span id="txtEventos">‚Äî</span></div>
        <div><b>Pontos do mapa:</b> <span id="txtPontos">‚Äî</span></div>
      </div>

      <div class="divider"></div>

      <div class="kpi">
        <div style="width:100%">
          <b>√çndice Ecol√≥gico Amaz√¥nico (0‚Äì100)</b> <span class="muted">(MVP)</span>
          <div style="margin-top:8px; height:10px; border-radius:99px; background: rgba(255,255,255,.08); overflow:hidden;">
            <div id="barIndex" style="height:10px; width:0%; background: linear-gradient(90deg, rgba(255,84,84,.95), rgba(255,214,102,.95), rgba(26,255,140,.95));"></div>
          </div>
          <div class="muted" style="margin-top:6px; font-size:12px;">
            Valor: <b id="txtIndex">‚Äî</b>
          </div>
        </div>
      </div>

    </div>

    <!-- Center map -->
    <div class="mapWrap panel" style="padding:0;">
      <div id="map"></div>

      <div class="mapHUD">
        <div class="big">‚óè Sistema ativo ‚Äî Amaz√¥nia</div>
        <div class="small">Pontos reais (EONET) + classifica√ß√£o üü¢üü°üî¥ por proximidade do dist√∫rbio.</div>
      </div>

      <div class="legend">
        <div style="font-weight:900;">Escala Ecol√≥gica (0‚Äì100)</div>
        <div class="bar"></div>
        <div class="labels">
          <span>Impacto</span>
          <span>Alerta</span>
          <span>Baixo dist√∫rbio</span>
        </div>
      </div>
    </div>

    <!-- Right -->
    <div class="panel">
      <h3>üì° Leituras em tempo real <span><span id="txtPontosRight">‚Äî</span> pontos</span></h3>
      <div class="muted" style="font-size:12px; line-height:1.5;">
        Clique em um ponto para ver os dados p√∫blicos e a classifica√ß√£o.
      </div>

      <div class="divider"></div>

      <div style="font-size:12px; line-height:1.6;">
        <b>√öltimo ponto selecionado</b><br/>
        <div class="muted" id="txtUltimo">‚Äî</div>
      </div>
    </div>

    <!-- Bottom row -->
    <div class="bottom">
      <div class="panel">
        <h3>üìà S√©rie temporal (MVP) <span>placeholder</span></h3>
        <div class="muted" style="font-size:12px; line-height:1.6;">
          Pr√≥ximo passo: gr√°fico real do √≠ndice por dia/semana (NDVI + fogo + anomalias + clima).
        </div>
      </div>

      <div class="panel">
        <h3>üß¨ Integridade / Cobertura <span>placeholder</span></h3>
        <div class="muted" style="font-size:12px; line-height:1.6;">
          Pr√≥ximo passo: m√©tricas reais por sat√©lite (NDVI/biomassa) e mudan√ßas de cobertura.
        </div>
      </div>

      <div class="panel">
        <h3>üîí Transpar√™ncia <span>jur√≠dico</span></h3>
        <div class="muted" style="font-size:12px; line-height:1.6;">
          Observat√≥rio Amaz√¥nia ‚Äî Transpar√™ncia ambiental baseada em dados p√∫blicos.<br/>
          Este projeto n√£o constitui oferta de investimento. Plataforma de monitoramento ambiental.
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalOverlay" id="modalOverlay" onclick="overlayClick(event)">
    <div class="modal">
      <div class="close" onclick="closeModal()">Fechar ‚úï</div>
      <div class="modalTitle" id="modalTitle"></div>
      <div id="modalBody"></div>
    </div>
  </div>

<script>
  // ====== MODAIS ======
  const content = {
    oquee: {
      title: "üåø O que √© o Observat√≥rio Bioecol√≥gico da Amaz√¥nia",
      body: `
        <p>
          Um painel p√∫blico que transforma <b>dados ambientais reais</b> em uma leitura visual do
          estado ecol√≥gico da floresta.
        </p>
        <p class="muted">
          Sem pre√ßo, sem promessa, sem venda: apenas monitoramento verific√°vel.
        </p>
      `
    },
    comofunciona: {
      title: "‚öôÔ∏è Como funciona (MVP)",
      body: `
        <ul class="bullet">
          <li><b>Sat√©lite real</b> (NASA GIBS / VIIRS) como base do mapa.</li>
          <li><b>Vegeta√ß√£o</b> (NDVI) como camada bi√≥tica <span class="muted">(pr√≥ximo passo)</span>.</li>
          <li><b>Dist√∫rbios</b> (anomalias t√©rmicas/fogo) <span class="muted">(MVP via EONET)</span>.</li>
          <li><b>Pontos reais</b> de inc√™ndio via NASA EONET (√∫ltimos 30 dias).</li>
        </ul>
        <p class="muted">
          Regra do Observat√≥rio: <b>dist√∫rbio</b> = üî¥ ‚Ä¢ <b>alerta</b> = üü° ‚Ä¢ <b>sem dist√∫rbio</b> = üü¢.
          No MVP atual, o ‚Äúalerta‚Äù √© definido por proximidade do dist√∫rbio.
        </p>
      `
    },
    painel: {
      title: "üìä Painel Amaz√¥nia ‚Äî voc√™ encontra",
      body: `
        <ul class="bullet">
          <li><b>Sistema ativo da Amaz√¥nia</b></li>
          <li><b>Dados p√∫blicos</b></li>
          <li><b>Atualiza√ß√£o cont√≠nua</b></li>
        </ul>
        <p class="muted">
          Mapa sat√©lite real + pontos ‚Äúpixel‚Äù dentro do bioma. Clique nos pontos para ver fonte e data do dist√∫rbio.
        </p>
      `
    }
  };

  function openModal(key){
    const overlay = document.getElementById("modalOverlay");
    const titleEl = document.getElementById("modalTitle");
    const bodyEl = document.getElementById("modalBody");
    const item = content[key];
    if(!item) return;
    titleEl.innerHTML = item.title;
    bodyEl.innerHTML = item.body;
    overlay.style.display = "flex";
  }
  function closeModal(){ document.getElementById("modalOverlay").style.display = "none"; }
  function overlayClick(e){ if(e.target.id === "modalOverlay") closeModal(); }
  document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

  // ====== MAPA ======
  const map = L.map("map", {
    zoomControl: true,
    preferCanvas: true
  });

  // VIIRS / NOAA-20 (via GIBS)
  // Observa√ß√£o: alguns tiles GIBS mudam; se falhar, a base ainda funciona com OSM fallback.
  const gibs = L.tileLayer(
    "https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_SNPP_CorrectedReflectance_TrueColor/default/{time}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg",
    {
      time: "2026-02-06", // MVP fixo (est√°tico). Depois voc√™ troca pra data din√¢mica.
      tileSize: 256,
      maxZoom: 9,
      attribution: "Leaflet | NASA GIBS (VIIRS)"
    }
  );

  const osmFallback = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "Leaflet | OSM"
  });

  gibs.addTo(map);

  // Camadas
  const layerMask = L.geoJSON(null, { interactive:false });
  const layerBorder = L.geoJSON(null, { interactive:false });
  const layerPixels = L.layerGroup().addTo(map);
  const layerEvents = L.layerGroup().addTo(map);

  // Ajuste de classifica√ß√£o (MVP)
  const DIST_RED_KM = 80;     // dist√∫rbio
  const DIST_YELLOW_KM = 220; // alerta

  // Grid (pontos ‚Äúpixel‚Äù dentro da Amaz√¥nia)
  // Quanto menor o passo, mais ‚Äúpixelado‚Äù, por√©m mais pesado.
  const GRID_STEP_KM = 55; // recomendado para ficar r√°pido no GitHub Pages
  const PIX_RADIUS = 4;    // tamanho do ‚Äúpixel‚Äù
  const HALO_RADIUS = 12;  // brilho

  // Estado
  let amazoniaFeature = null;
  let events = []; // [{lat, lon, title, date, source}]

  function setOnline(text){
    document.getElementById("statusOnline").textContent = text;
  }

  function voltar(){
    // volta pro index
    window.location.href = "index.html";
  }

  function fmtNow(){
    const d = new Date();
    return d.toLocaleString("pt-BR");
  }

  function corPorClasse(cls){
    if(cls === "disturbio") return "rgba(255,84,84,.95)";
    if(cls === "alerta") return "rgba(255,214,102,.95)";
    return "rgba(26,255,140,.95)";
  }

  function classificarPorDistanciaKm(minKm){
    if(minKm <= DIST_RED_KM) return "disturbio";
    if(minKm <= DIST_YELLOW_KM) return "alerta";
    return "ok";
  }

  function haversineKm(lat1, lon1, lat2, lon2){
    const R = 6371;
    const toRad = (v)=> v * Math.PI/180;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a =
      Math.sin(dLat/2)**2 +
      Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R*c;
  }

  function nearestEventDistanceKm(lat, lon){
    if(events.length === 0) return Infinity;
    let min = Infinity;
    let best = null;
    for(const e of events){
      const km = haversineKm(lat, lon, e.lat, e.lon);
      if(km < min){
        min = km;
        best = e;
      }
    }
    return { minKm: min, best };
  }

  async function carregarAmazonia(){
    const res = await fetch("amazonia.geojson", { cache: "no-store" });
    if(!res.ok) throw new Error("N√£o achei amazonia.geojson (erro " + res.status + ")");
    const gj = await res.json();

    // assume 1 feature
    amazoniaFeature = gj.features && gj.features[0] ? gj.features[0] : null;
    if(!amazoniaFeature) throw new Error("amazonia.geojson sem feature v√°lida.");

    // Ajuste de mapa
    const b = L.geoJSON(gj).getBounds();
    map.fitBounds(b.pad(0.12));

    // Borda do bioma
    layerBorder.clearLayers();
    layerBorder.addData(gj);
    layerBorder.setStyle({
      color: "rgba(26,255,140,.55)",
      weight: 2,
      fillOpacity: 0
    });
    layerBorder.addTo(map);

    // M√°scara fora do bioma (buraco da Amaz√¥nia)
    // cria um ret√¢ngulo global e fura com a Amaz√¥nia
    const world = turf.polygon([[[-180,-85], [180,-85], [180,85], [-180,85], [-180,-85]]]);
    const hole = amazoniaFeature.geometry;
    const mask = turf.difference(world, hole ? turf.feature(hole) : null);
    if(mask){
      layerMask.clearLayers();
      layerMask.addData(mask);
      layerMask.setStyle({
        color: "rgba(0,0,0,0)",
        weight: 0,
        fillColor: "rgba(0,0,0,.72)",
        fillOpacity: 1
      });
      layerMask.addTo(map);
    }
  }

  async function carregarEventosEONET(){
    // Wildfires √∫ltimos 30 dias (EONET)
    // OBS: alguns IDs mudam; caso caia, o painel continua com pixels ‚Äúok‚Äù.
    const url = "https://eonet.gsfc.nasa.gov/api/v3/events?status=open&category=wildfires&days=30";
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("Falha ao buscar EONET (erro " + res.status + ")");
    const json = await res.json();

    events = [];
    const feats = json.events || [];
    for(const ev of feats){
      // pega coordenadas do ponto mais recente (quando existir)
      // EONET v3: geometry √© array de { magnitudeValue, magnitudeUnit, date, type, coordinates }
      const g = ev.geometry && ev.geometry.length ? ev.geometry[ev.geometry.length - 1] : null;
      if(!g || !g.coordinates || g.coordinates.length < 2) continue;

      const lon = g.coordinates[0];
      const lat = g.coordinates[1];

      // filtra dentro do bioma (ponto dentro do pol√≠gono)
      const pt = turf.point([lon, lat]);
      if(amazoniaFeature && !turf.booleanPointInPolygon(pt, amazoniaFeature)) continue;

      events.push({
        lat, lon,
        title: ev.title || "Inc√™ndio (EONET)",
        date: g.date || "",
        source: "NASA EONET"
      });
    }

    // desenha eventos reais como ‚Äúpontos fortes‚Äù (vermelhos)
    layerEvents.clearLayers();
    for(const e of events){
      const c = "rgba(255,84,84,.95)";
      const halo = L.circleMarker([e.lat, e.lon], {
        radius: 18,
        color: c,
        weight: 0,
        fillColor: c,
        fillOpacity: 0.18
      });
      const core = L.circleMarker([e.lat, e.lon], {
        radius: 6,
        color: c,
        weight: 2,
        fillColor: c,
        fillOpacity: 0.55
      });
      const html = `
        <b>${e.title}</b><br/>
        Fonte: ${e.source}<br/>
        Data: ${e.date || "‚Äî"}<br/>
        Lat: ${e.lat.toFixed(3)} | Lon: ${e.lon.toFixed(3)}
      `;
      core.bindPopup(html);
      halo.addTo(layerEvents);
      core.addTo(layerEvents);
    }
  }

  function gerarGridDentroAmazonia(){
    layerPixels.clearLayers();

    // bbox do bioma
    const bbox = turf.bbox(amazoniaFeature);

    // converte km para graus (aproxima√ß√£o; ok no MVP)
    const stepLat = GRID_STEP_KM / 110.574; // 1 grau lat ~110.6 km
    const midLat = (bbox[1] + bbox[3]) / 2;
    const stepLon = GRID_STEP_KM / (111.320 * Math.cos(midLat * Math.PI/180));

    let total = 0;
    let countG = 0, countY = 0, countR = 0;

    for(let lat = bbox[1]; lat <= bbox[3]; lat += stepLat){
      for(let lon = bbox[0]; lon <= bbox[2]; lon += stepLon){
        const pt = turf.point([lon, lat]);
        if(!turf.booleanPointInPolygon(pt, amazoniaFeature)) continue;

        // classifica por proximidade do dist√∫rbio real
        const { minKm, best } = nearestEventDistanceKm(lat, lon);
        const cls = classificarPorDistanciaKm(minKm);
        const c = corPorClasse(cls);

        if(cls === "ok") countG++;
        else if(cls === "alerta") countY++;
        else countR++;
        total++;

        // HALO HUD
        L.circleMarker([lat, lon], {
          radius: HALO_RADIUS,
          color: c,
          weight: 0,
          fillColor: c,
          fillOpacity: 0.10
        }).addTo(layerPixels);

        // PIXEL
        const m = L.circleMarker([lat, lon], {
          radius: PIX_RADIUS,
          color: c,
          weight: 1.5,
          fillColor: c,
          fillOpacity: 0.55
        });

        const distText = (minKm === Infinity) ? "‚Äî" : (minKm.toFixed(1) + " km");
        const eventoText = best ? `<br/><b>Dist√∫rbio mais pr√≥ximo:</b> ${best.title}<br/><b>Fonte:</b> ${best.source}<br/><b>Data:</b> ${best.date || "‚Äî"}` : "";
        m.bindPopup(`
          <b>Ponto (pixel)</b><br/>
          Classifica√ß√£o: <b>${cls === "ok" ? "üü¢ sem dist√∫rbio" : (cls === "alerta" ? "üü° alerta" : "üî¥ dist√∫rbio")}</b><br/>
          Dist√¢ncia do dist√∫rbio mais pr√≥ximo: <b>${distText}</b><br/>
          Lat: ${lat.toFixed(3)} | Lon: ${lon.toFixed(3)}
          ${eventoText}
        `);

        m.on("click", ()=>{
          const last = document.getElementById("txtUltimo");
          last.innerHTML = `
            Classifica√ß√£o: <b>${cls === "ok" ? "üü¢ sem dist√∫rbio" : (cls === "alerta" ? "üü° alerta" : "üî¥ dist√∫rbio")}</b><br/>
            Dist√¢ncia do dist√∫rbio mais pr√≥ximo: <b>${distText}</b><br/>
            Lat: ${lat.toFixed(3)} | Lon: ${lon.toFixed(3)}
          `;
        });

        m.addTo(layerPixels);
      }
    }

    // √çndice (MVP): verde=1, amarelo=0.5, vermelho=0
    const idx = total ? Math.round(100 * ((countG*1 + countY*0.5 + countR*0) / total)) : 0;

    document.getElementById("txtPontos").textContent = total;
    document.getElementById("txtPontosRight").textContent = total;
    document.getElementById("txtEventos").textContent = events.length;
    document.getElementById("txtAtualizacao").textContent = fmtNow();
    document.getElementById("txtIndex").textContent = idx;

    const bar = document.getElementById("barIndex");
    bar.style.width = Math.max(0, Math.min(100, idx)) + "%";
  }

  async function atualizarTudo(){
    try{
      setOnline("online");

      // tenta base NASA; se der ruim, fallback OSM
      try{
        // se tile der erro em alguns browsers, n√£o derruba o resto
        // (sem listener aqui; mantemos simples)
      }catch(e){}

      await carregarAmazonia();
      await carregarEventosEONET(); // dist√∫rbio real (fogo)
      gerarGridDentroAmazonia();

    }catch(err){
      setOnline("erro");
      alert("Erro ao atualizar: " + err.message + "\n\nCONFIRA:\n- existe amazonia.geojson na raiz?\n- o nome √© igual (mai√∫scula/min√∫scula)?\n- o GitHub Pages j√° atualizou?");
      // fallback base
      try{
        if(!map.hasLayer(osmFallback)) osmFallback.addTo(map);
      }catch(e){}
    }
  }

  // Start + auto refresh
  atualizarTudo();
  setInterval(atualizarTudo, 10 * 60 * 1000);
</script>

</body>
</html>
