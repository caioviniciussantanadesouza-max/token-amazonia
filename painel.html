<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Painel ‚Äî Observat√≥rio Amaz√¥nia</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#05080f;
      --panel: rgba(6,10,18,.78);
      --panel2: rgba(6,10,18,.62);
      --line: rgba(26,255,140,.25);
      --neon:#1aff8c;
      --text:#e4e9f2;
      --muted:#9bb0d3;

      --red:#ff375f;
      --yellow:#ffd166;
      --green:#2bff8a;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:Arial, Helvetica, sans-serif; }

    /* ===== Layout HUD ===== */
    .app{
      height:100%;
      display:grid;
      grid-template-rows: 64px 1fr 168px;
      gap:10px;
      padding:10px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
    }
    .brand .title{
      font-weight:900;
      letter-spacing:.3px;
      font-size:1.05em;
      white-space:nowrap;
    }
    .brand .sub{
      color:rgba(228,233,242,.75);
      font-size:.85em;
      white-space:nowrap;
    }

    .chips{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:center;
    }

    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(0,0,0,.25);
      cursor:pointer;
      user-select:none;
      font-weight:800;
      transition:.2s;
      white-space:nowrap;
    }
    .chip:hover{
      border-color: rgba(26,255,140,.55);
      box-shadow:0 0 18px rgba(26,255,140,.15);
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      transition:.2s;
      white-space:nowrap;
      text-decoration:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .btn:hover{
      border-color: rgba(26,255,140,.55);
      box-shadow:0 0 18px rgba(26,255,140,.15);
    }
    .btn.primary{
      border-color: rgba(26,255,140,.55);
      color: var(--neon);
    }

    .main{
      display:grid;
      grid-template-columns: 320px 1fr 320px;
      gap:10px;
      min-height:0;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      backdrop-filter: blur(10px);
      overflow:auto;
    }

    .panel h3{
      margin:0 0 10px 0;
      font-size:.95em;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    .panel .muted{ color:var(--muted); font-size:.88em; line-height:1.45; }
    .panel .small{ color:rgba(228,233,242,.75); font-size:.82em; }

    .mapWrap{
      position:relative;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(26,255,140,.22);
      background:#0b0f1a;
      min-height:0;
    }

    #map{
      height:100%;
      width:100%;
    }

    /* HUD overlay on map */
    .hudBox{
      position:absolute;
      left:14px;
      top:14px;
      z-index:500;
      background:var(--panel2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
      max-width:360px;
    }
    .hudBox .line1{ font-weight:900; }
    .hudBox .line2{ font-size:.85em; color:rgba(228,233,242,.8); margin-top:3px; }

    .legend{
      position:absolute;
      left:14px;
      bottom:14px;
      z-index:500;
      background:var(--panel2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
      width:320px;
    }
    .legend .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .bar{
      height:10px;
      border-radius:999px;
      background: linear-gradient(90deg, var(--red), var(--yellow), var(--green));
      border:1px solid rgba(255,255,255,.12);
      margin-top:8px;
    }
    .legend .labels{
      display:flex;
      justify-content:space-between;
      font-size:.78em;
      margin-top:6px;
      color:rgba(228,233,242,.75);
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      display:inline-block;
      margin-right:6px;
    }

    .bottom{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      min-height:0;
    }

    /* ===== Modal ===== */
    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.75);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .modal{
      width:min(860px, calc(100vw - 28px));
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px;
      backdrop-filter: blur(12px);
      box-shadow:0 10px 40px rgba(0,0,0,.55);
    }
    .modalTitle{ font-weight:900; font-size:1.05em; }
    .modalBody{ margin-top:12px; color:#dfe7ff; line-height:1.6; }
    .close{
      float:right;
      cursor:pointer;
      font-weight:900;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      user-select:none;
    }
    .close:hover{ border-color: rgba(26,255,140,.55); }

    ul.bullet{ padding-left:18px; }
    ul.bullet li{ margin:8px 0; }

    /* ===== Holographic markers ===== */
    .pulse{
      width:14px;
      height:14px;
      border-radius:50%;
      position:relative;
      box-shadow: 0 0 16px currentColor;
    }
    .pulse::before{
      content:"";
      position:absolute;
      inset:-14px;
      border-radius:999px;
      border:2px solid currentColor;
      opacity:.35;
      animation:pulse 1.6s infinite ease-out;
    }
    .pulse::after{
      content:"";
      position:absolute;
      inset:-28px;
      border-radius:999px;
      border:2px solid currentColor;
      opacity:.18;
      animation:pulse 2.2s infinite ease-out;
    }

    @keyframes pulse{
      0%{ transform:scale(.25); opacity:.55; }
      100%{ transform:scale(1); opacity:0; }
    }

    /* Mobile */
    @media (max-width: 980px){
      .main{ grid-template-columns: 1fr; }
      .bottom{ grid-template-columns: 1fr; }
      .panel{ max-height:220px; }
      .mapWrap{ height:54vh; }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- TOP -->
    <div class="topbar">
      <div class="brand">
        <div class="title">PAINEL AMAZ√îNIA ‚Äî Observat√≥rio Bioecol√≥gico</div>
        <div class="sub">Dados p√∫blicos ‚Ä¢ Atualiza√ß√£o cont√≠nua ‚Ä¢ Escala 0‚Äì100</div>
      </div>

      <div class="chips">
        <div class="chip" onclick="openModal('oquee')">üåø O que √©</div>
        <div class="chip" onclick="openModal('comofunciona')">‚öôÔ∏è Como funciona</div>
        <div class="chip" onclick="openModal('painel')">üìä Painel</div>
      </div>

      <div class="actions">
        <a class="btn" href="index.html">‚Üê Voltar</a>
        <button class="btn primary" onclick="atualizarTudo()">‚ü≥ Atualizar</button>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">

      <!-- LEFT -->
      <div class="panel">
        <h3>üß© Camadas P√∫blicas <span class="small" id="statusOnline">online</span></h3>

        <div class="muted">
          Base: Sat√©lite (NASA GIBS / VIIRS)<br>
          Pontos (reais): Inc√™ndios (NASA EONET)<br><br>
          <b>Regra:</b><br>
          <span class="dot" style="background:var(--green)"></span>üü¢ sem dist√∫rbio<br>
          <span class="dot" style="background:var(--yellow)"></span>üü° alerta<br>
          <span class="dot" style="background:var(--red)"></span>üî¥ dist√∫rbio (evento real)
        </div>

        <div style="height:10px"></div>
        <div class="small">Atualiza√ß√£o: <span id="lastUpdate">‚Äî</span></div>
        <div class="small">Eventos carregados: <span id="countEventos">0</span></div>
        <div class="small">Pontos do mapa: <span id="countPontos">0</span></div>
      </div>

      <!-- MAP -->
      <div class="mapWrap">
        <div id="map"></div>

        <div class="hudBox">
          <div class="line1">‚óè Sistema ativo ‚Äî Amaz√¥nia</div>
          <div class="line2">Pontos reais (EONET) + classifica√ß√£o por zona (alerta/dist√∫rbio).</div>
        </div>

        <div class="legend">
          <div class="row">
            <div style="font-weight:900">√çndice Ecol√≥gico Amaz√¥nico (0‚Äì100)</div>
            <div class="small">MVP</div>
          </div>
          <div class="bar"></div>
          <div class="labels">
            <span>impacto</span><span>alerta</span><span>baixo dist√∫rbio</span>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <h3>üìå Leituras em tempo real <span class="small"><span id="pontosRight">0</span> pontos</span></h3>
        <div class="muted">
          Clique em um ponto para ver os dados p√∫blicos usados na classifica√ß√£o.
        </div>

        <hr style="border:0;border-top:1px solid rgba(255,255,255,.08); margin:12px 0;">

        <div class="small"><b>√öltimo ponto selecionado</b></div>
        <div class="muted" id="lastPoint">‚Äî</div>
      </div>

    </div>

    <!-- BOTTOM -->
    <div class="bottom">
      <div class="panel">
        <h3>üìà S√©rie temporal (MVP) <span class="small">placeholder</span></h3>
        <div class="muted">
          Pr√≥ximo passo: gr√°fico real do √≠ndice por dia/semana (NDVI + fogo + anomalias + clima).
        </div>
      </div>
      <div class="panel">
        <h3>üß¨ Integridade / Cobertura <span class="small">placeholder</span></h3>
        <div class="muted">
          Pr√≥ximo passo: m√©tricas reais por sat√©lite (NDVI/biomassa) e mudan√ßas de cobertura.
        </div>
      </div>
      <div class="panel">
        <h3>üîí Transpar√™ncia <span class="small">jur√≠dico</span></h3>
        <div class="muted">
          Observat√≥rio Amaz√¥nia ‚Äî Transpar√™ncia ambiental baseada em dados p√∫blicos.<br>
          Este projeto n√£o constitui oferta de investimento. Plataforma de monitoramento ambiental.
        </div>
      </div>
    </div>

  </div>

  <!-- MODAL -->
  <div class="modalOverlay" id="modalOverlay" onclick="overlayClick(event)">
    <div class="modal">
      <div class="close" onclick="closeModal()">Fechar ‚úï</div>
      <div class="modalTitle" id="modalTitle"></div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ====== AMAZ√îNIA (recorte MVP por bbox) ======
    // (BBOX ampla do bioma Amaz√¥nia ‚Äî para MVP visual e recorte do mundo)
    const AMAZON_BBOX = {
      west:  -80,
      south: -20,
      east:  -44,
      north:   6
    };

    const AMAZON_BOUNDS = L.latLngBounds(
      [AMAZON_BBOX.south, AMAZON_BBOX.west],
      [AMAZON_BBOX.north, AMAZON_BBOX.east]
    );

    // ====== MAPA ======
    const map = L.map("map", {
      zoomControl: true,
      preferCanvas: true
    });

    map.fitBounds(AMAZON_BOUNDS);
    map.setMaxBounds(AMAZON_BOUNDS.pad(0.12)); // segura a c√¢mera
    map.on("drag", () => map.panInsideBounds(AMAZON_BOUNDS, { animate:false }));

    // Base sat√©lite (NASA GIBS) ‚Äî VIIRS (imagem do dia / global)
    const base = L.tileLayer(
      "https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_SNPP_CorrectedReflectance_TrueColor/default/{time}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg",
      {
        time: new Date().toISOString().slice(0,10), // YYYY-MM-DD
        tileSize: 256,
        maxZoom: 9,
        attribution: "NASA GIBS (VIIRS)"
      }
    ).addTo(map);

    // ====== M√°scara (escurece fora da Amaz√¥nia) ======
    // Pol√≠gono: mundo inteiro com "buraco" na caixa amaz√¥nica (MVP)
    const world = [
      [-90,-180],[-90,180],[90,180],[90,-180]
    ];
    const hole = [
      [AMAZON_BBOX.south, AMAZON_BBOX.west],
      [AMAZON_BBOX.south, AMAZON_BBOX.east],
      [AMAZON_BBOX.north, AMAZON_BBOX.east],
      [AMAZON_BBOX.north, AMAZON_BBOX.west]
    ];
    L.polygon([world, hole], {
      stroke:false,
      fillColor:"#000",
      fillOpacity:0.62
    }).addTo(map);

    // Borda da Amaz√¥nia (bbox) para refor√ßar recorte HUD
    L.rectangle(AMAZON_BOUNDS, {
      color:"rgba(26,255,140,.35)",
      weight:2,
      fillOpacity:0
    }).addTo(map);

    // ====== CAMADAS ======
    const layerEventos = L.layerGroup().addTo(map);
    const layerPontos  = L.layerGroup().addTo(map);

    // ====== UTIL ======
    function insideAmazon(lat, lon){
      return (
        lon >= AMAZON_BBOX.west && lon <= AMAZON_BBOX.east &&
        lat >= AMAZON_BBOX.south && lat <= AMAZON_BBOX.north
      );
    }

    function haversineKm(aLat, aLon, bLat, bLon){
      const R = 6371;
      const dLat = (bLat-aLat) * Math.PI/180;
      const dLon = (bLon-aLon) * Math.PI/180;
      const la1 = aLat * Math.PI/180;
      const la2 = bLat * Math.PI/180;
      const x = Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(x));
    }

    function classificarPorDistancia(minKm){
      // üî¥ dist√∫rbio: muito perto do evento real
      if(minKm <= 50) return { cls:"disturbio", color:"var(--red)", label:"üî¥ dist√∫rbio" };
      // üü° alerta: zona de risco ao redor
      if(minKm <= 150) return { cls:"alerta", color:"var(--yellow)", label:"üü° alerta" };
      // üü¢ sem dist√∫rbio
      return { cls:"ok", color:"var(--green)", label:"üü¢ sem dist√∫rbio" };
    }

    function makeHoloIcon(cssColor){
      return L.divIcon({
        className: "",
        html: `<div class="pulse" style="color:${cssColor}; background:${cssColor};"></div>`,
        iconSize: [14,14],
        iconAnchor: [7,7]
      });
    }

    function setLastPoint(html){
      document.getElementById("lastPoint").innerHTML = html;
    }

    function setStatus(ok){
      document.getElementById("statusOnline").textContent = ok ? "online" : "erro";
      document.getElementById("statusOnline").style.color = ok ? "rgba(228,233,242,.75)" : "#ff5c7a";
    }

    function setUpdateTime(){
      const d = new Date();
      const s = d.toLocaleString("pt-BR");
      document.getElementById("lastUpdate").textContent = s;
    }

    // ====== DADOS REAIS (EONET) ======
    // Wildfires: categoria 8 no EONET (padr√£o)
    const EONET_API = "https://eonet.gsfc.nasa.gov/api/v3/events?status=open&category=wildfires&limit=200";

    async function fetchEonet(){
      const res = await fetch(EONET_API, { cache:"no-store" });
      if(!res.ok) throw new Error("EONET falhou (HTTP " + res.status + ")");
      return await res.json();
    }

    function extractPointsFromEonet(json){
      // Pega geometrias e filtra p/ Amazon bbox
      const pts = [];
      for(const ev of (json.events || [])){
        const title = ev.title || "Evento";
        const id = ev.id || "";
        const source = (ev.sources && ev.sources[0] && ev.sources[0].url) ? ev.sources[0].url : "";
        const geos = ev.geometry || [];

        for(const g of geos){
          if(!g || !g.coordinates) continue;
          // EONET vem [lon,lat]
          const lon = g.coordinates[0];
          const lat = g.coordinates[1];
          if(typeof lat !== "number" || typeof lon !== "number") continue;
          if(!insideAmazon(lat, lon)) continue;

          pts.push({
            lat, lon,
            title,
            id,
            date: g.date || "",
            source
          });
        }
      }
      return pts;
    }

    // ====== GERA ‚ÄúPONTOS DO MAPA‚Äù (verde/amarelo/vermelho) ======
    function generateGridPoints(){
      // grade simples para dar sensa√ß√£o ‚Äúcada pixel = bolinha‚Äù
      // (MVP leve: n√£o explode o navegador)
      const step = 2.5; // graus (ajusta densidade)
      const points = [];
      for(let lat = AMAZON_BBOX.south; lat <= AMAZON_BBOX.north; lat += step){
        for(let lon = AMAZON_BBOX.west; lon <= AMAZON_BBOX.east; lon += step){
          points.push({ lat, lon });
        }
      }
      return points;
    }

    function minDistanceToEventsKm(p, events){
      let min = Infinity;
      for(const e of events){
        const d = haversineKm(p.lat, p.lon, e.lat, e.lon);
        if(d < min) min = d;
      }
      return min;
    }

    function renderEvents(events){
      layerEventos.clearLayers();

      for(const e of events){
        const mk = L.marker([e.lat, e.lon], { icon: makeHoloIcon("var(--red)") });

        const html =
          `<b>üî¥ dist√∫rbio (evento real)</b><br>` +
          `<b>${e.title}</b><br>` +
          `Data: ${e.date || "‚Äî"}<br>` +
          `Lat: ${e.lat.toFixed(4)} | Lon: ${e.lon.toFixed(4)}<br>` +
          (e.source ? `Fonte: <a href="${e.source}" target="_blank" rel="noopener">NASA EONET</a>` : `Fonte: NASA EONET`);

        mk.bindPopup(html);
        mk.on("click", () => setLastPoint(html));
        mk.addTo(layerEventos);
      }

      document.getElementById("countEventos").textContent = events.length;
    }

    function renderGrid(grid, events){
      layerPontos.clearLayers();

      let count = 0;
      for(const p of grid){
        const minKm = events.length ? minDistanceToEventsKm(p, events) : Infinity;
        const cls = classificarPorDistancia(minKm);

        const mk = L.marker([p.lat, p.lon], { icon: makeHoloIcon(cls.color) });

        const info =
          `<b>${cls.label}</b><br>` +
          `Dist√¢ncia do dist√∫rbio mais pr√≥ximo: <b>${isFinite(minKm) ? Math.round(minKm) + " km" : "‚Äî"}</b><br>` +
          `Lat: ${p.lat.toFixed(2)} | Lon: ${p.lon.toFixed(2)}`;

        mk.bindPopup(info);
        mk.on("click", () => setLastPoint(info));
        mk.addTo(layerPontos);

        count++;
      }

      document.getElementById("countPontos").textContent = count;
      document.getElementById("pontosRight").textContent = count;
    }

    // ====== MODAIS ======
    const content = {
      oquee: {
        title: "üåø O que √© o Observat√≥rio Bioecol√≥gico da Amaz√¥nia",
        body: `
          <p>
            Um painel p√∫blico que transforma <b>dados ambientais reais</b> em uma leitura visual do
            estado ecol√≥gico da floresta.
          </p>
          <p class="muted">
            Sem pre√ßo, sem promessa, sem venda: apenas monitoramento verific√°vel.
          </p>
        `
      },
      comofunciona: {
        title: "‚öôÔ∏è Como funciona (MVP)",
        body: `
          <ul class="bullet">
            <li><b>Sat√©lite real</b> (NASA GIBS / VIIRS) como base do mapa.</li>
            <li><b>Dist√∫rbios</b> (fogo / anomalias t√©rmicas) via <b>eventos p√∫blicos</b>.</li>
            <li><b>Pontos reais</b> via NASA EONET, filtrados para a <b>Amaz√¥nia</b>.</li>
            <li><b>NDVI</b> e camadas bi√≥ticas entram na pr√≥xima vers√£o.</li>
          </ul>
          <p class="muted">
            Regra do Observat√≥rio: <b>dist√∫rbio</b> = üî¥ ‚Ä¢ <b>alerta</b> = üü° ‚Ä¢ <b>sem dist√∫rbio</b> = üü¢.
          </p>
        `
      },
      painel: {
        title: "üìä Painel Amaz√¥nia ‚Äî voc√™ encontra",
        body: `
          <ul class="bullet">
            <li><b>Sistema ativo da Amaz√¥nia</b></li>
            <li><b>Dados p√∫blicos</b></li>
            <li><b>Atualiza√ß√£o cont√≠nua</b></li>
          </ul>
          <p class="muted">
            Sat√©lite real + pontos hologr√°ficos (EONET). Clique nos pontos para ver fonte e classifica√ß√£o.
          </p>
        `
      }
    };

    function openModal(key){
      const overlay = document.getElementById("modalOverlay");
      const titleEl = document.getElementById("modalTitle");
      const bodyEl = document.getElementById("modalBody");
      const item = content[key];
      if(!item) return;
      titleEl.innerHTML = item.title;
      bodyEl.innerHTML = item.body;
      overlay.style.display = "flex";
    }
    function closeModal(){ document.getElementById("modalOverlay").style.display = "none"; }
    function overlayClick(e){ if(e.target.id === "modalOverlay") closeModal(); }
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

    // ====== Atualiza√ß√£o ======
    async function atualizarTudo(){
      try{
        setStatus(true);
        setUpdateTime();
        setLastPoint("‚Äî");

        const json = await fetchEonet();
        const eventos = extractPointsFromEonet(json);

        renderEvents(eventos);

        const grid = generateGridPoints();
        renderGrid(grid, eventos);

        setStatus(true);
      }catch(err){
        setStatus(false);
        alert("Erro ao atualizar: " + err.message);
      }
    }

    // start
    atualizarTudo();
    setInterval(atualizarTudo, 10 * 60 * 1000);
  </script>
</body>
</html>
