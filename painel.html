<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel ‚Äî Observat√≥rio Bioecol√≥gico da Amaz√¥nia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#05080f;
      --panel: rgba(6,10,18,.82);
      --line: rgba(26,255,140,.25);
      --line2: rgba(26,255,140,.15);
      --neon:#1aff8c;
      --text:#e4e9f2;
      --muted:#9bb0d3;
      --danger:#ff4040;
      --warn:#ffd94a;
      --ok:#1aff8c;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow:hidden;
    }

    /* ====== LAYOUT ====== */
    .app{
      height:100vh;
      display:grid;
      grid-template-columns: 320px 1fr 320px;
      grid-template-rows: 74px 1fr 160px;
      gap:12px;
      padding:12px;
    }

    .topbar{
      grid-column: 1 / 4;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      background: var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 320px;
    }
    .brand .t1{
      font-weight:900;
      letter-spacing:.3px;
      font-size: 14px;
    }
    .brand .t2{
      font-size:12px;
      color: rgba(228,233,242,.75);
    }

    .chips{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      flex:1;
    }
    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border:1px solid var(--line);
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      transition:.2s;
      background: rgba(0,0,0,.25);
      font-weight:800;
      white-space:nowrap;
    }
    .chip:hover{
      border-color: rgba(26,255,140,.55);
      box-shadow:0 0 18px rgba(26,255,140,.12);
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      min-width: 320px;
      justify-content:flex-end;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border:1px solid var(--line);
      color: var(--text);
      text-decoration:none;
      border-radius:999px;
      background: rgba(0,0,0,.25);
      font-weight:900;
      cursor:pointer;
      transition:.2s;
    }
    .btn:hover{
      border-color: rgba(26,255,140,.55);
      box-shadow:0 0 18px rgba(26,255,140,.12);
    }

    .card{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      backdrop-filter: blur(10px);
      padding:12px;
      overflow:hidden;
      position:relative;
    }

    .left{ grid-column:1; grid-row:2; }
    .right{ grid-column:3; grid-row:2; }
    .mapwrap{ grid-column:2; grid-row:2; padding:0; }
    .bottomA{ grid-column:1; grid-row:3; }
    .bottomB{ grid-column:2; grid-row:3; }
    .bottomC{ grid-column:3; grid-row:3; }

    .card h3{
      margin:0 0 10px;
      font-size:13px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      color: rgba(228,233,242,.95);
    }
    .muted{ color: var(--muted); }

    /* ====== MAPA ====== */
    #map{
      width:100%;
      height:100%;
      border-radius:16px;
      border:1px solid var(--line);
      overflow:hidden;
    }

    /* HUD overlay no mapa */
    .mapHUD{
      position:absolute;
      inset:0;
      pointer-events:none;
      border-radius:16px;
      box-shadow: inset 0 0 0 1px rgba(26,255,140,.12);
    }
    .mapHUD::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at 30% 20%, rgba(26,255,140,.10), transparent 55%),
        radial-gradient(circle at 70% 70%, rgba(26,255,140,.08), transparent 60%),
        linear-gradient(transparent, rgba(0,0,0,.15));
      opacity:.9;
    }

    /* status box dentro do mapa */
    .statusBox{
      position:absolute;
      left:14px;
      top:14px;
      width:min(360px, calc(100% - 28px));
      padding:10px 12px;
      background: rgba(6,10,18,.78);
      border:1px solid var(--line);
      border-radius:12px;
      backdrop-filter: blur(8px);
      z-index:500;
      pointer-events:auto;
    }
    .statusLine{
      display:flex;
      gap:8px;
      align-items:center;
      font-weight:900;
      font-size:13px;
      margin-bottom:6px;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--ok);
      box-shadow: 0 0 10px rgba(26,255,140,.35);
    }
    .dot.erro{ background: var(--danger); box-shadow:0 0 10px rgba(255,64,64,.35); }

    /* legenda */
    .legendBox{
      position:absolute;
      left:14px;
      bottom:14px;
      width: 260px;
      padding:10px 12px;
      background: rgba(6,10,18,.78);
      border:1px solid var(--line);
      border-radius:12px;
      backdrop-filter: blur(8px);
      z-index:500;
      pointer-events:none;
    }
    .legendTitle{
      font-weight:900;
      font-size:12px;
      margin-bottom:8px;
    }
    .bar{
      height:10px;
      border-radius:999px;
      background: linear-gradient(90deg, var(--danger), var(--warn), var(--ok));
      border:1px solid rgba(255,255,255,.08);
      margin-bottom:8px;
    }
    .legendRow{
      display:flex;
      justify-content:space-between;
      font-size:11px;
      color: rgba(228,233,242,.85);
    }

    /* ===== PONTOS HOLOGR√ÅFICOS ===== */
    .ponto{
      width:12px;
      height:12px;
      border-radius:50%;
      position:relative;
    }
    .ponto::after{
      content:"";
      position:absolute;
      left:50%;
      top:50%;
      width:46px;
      height:46px;
      transform:translate(-50%,-50%);
      border-radius:50%;
      opacity:.35;
      animation:pulse 2.4s infinite;
      filter: blur(.2px);
    }
    @keyframes pulse{
      0%{ transform:translate(-50%,-50%) scale(.35); opacity:.55; }
      70%{ transform:translate(-50%,-50%) scale(1.6); opacity:0; }
      100%{ opacity:0; }
    }

    .verde{
      background: var(--ok);
      box-shadow: 0 0 14px rgba(26,255,140,.85);
    }
    .verde::after{ background: var(--ok); }

    .amarelo{
      background: var(--warn);
      box-shadow: 0 0 14px rgba(255,217,74,.85);
    }
    .amarelo::after{ background: var(--warn); }

    .vermelho{
      background: var(--danger);
      box-shadow: 0 0 14px rgba(255,64,64,.85);
    }
    .vermelho::after{ background: var(--danger); }

    /* Modal */
    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.75);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:14px;
    }
    .modal{
      width:min(860px, 100%);
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px;
      backdrop-filter: blur(10px);
      box-shadow:0 10px 40px rgba(0,0,0,.55);
    }
    .modalTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .modalTitle{ font-weight:900; letter-spacing:.3px; }
    .close{
      cursor:pointer;
      font-weight:900;
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 12px;
      background: rgba(0,0,0,.25);
    }
    .close:hover{ border-color: rgba(26,255,140,.55); }
    .modalBody{ color:#dfe7ff; line-height:1.6; }
    ul.bullet{ padding-left:18px; }
    ul.bullet li{ margin:8px 0; }

    /* Responsivo b√°sico */
    @media (max-width: 1100px){
      body{ overflow:auto; }
      .app{
        height:auto;
        grid-template-columns: 1fr;
        grid-template-rows: 74px 520px auto auto auto;
      }
      .topbar{ grid-column:1; }
      .mapwrap{ grid-column:1; grid-row:2; height:520px; }
      .left{ grid-column:1; grid-row:3; }
      .right{ grid-column:1; grid-row:4; }
      .bottomA,.bottomB,.bottomC{ grid-column:1; }
      .bottomA{ grid-row:5; }
      .bottomB{ grid-row:6; }
      .bottomC{ grid-row:7; }
      .brand,.actions{ min-width:auto; }
      .chips{ display:none; }
    }
  </style>
</head>

<body>
  <div class="app">

    <div class="topbar">
      <div class="brand">
        <div class="t1">PAINEL AMAZ√îNIA ‚Äî Observat√≥rio Bioecol√≥gico</div>
        <div class="t2">Dados p√∫blicos ‚Ä¢ Atualiza√ß√£o cont√≠nua ‚Ä¢ Escala 0‚Äì100</div>
      </div>

      <div class="chips">
        <div class="chip" onclick="openModal('oquee')">üåø O que √©</div>
        <div class="chip" onclick="openModal('comofunciona')">‚öôÔ∏è Como funciona</div>
        <div class="chip" onclick="openModal('painel')">üìä Painel</div>
      </div>

      <div class="actions">
        <a class="btn" href="index.html">‚Üê Voltar</a>
        <button class="btn" onclick="atualizarTudo()">‚Üª Atualizar</button>
      </div>
    </div>

    <div class="card left">
      <h3>üß© Camadas P√∫blicas <span class="muted">on-line</span></h3>
      <div style="font-size:12px; line-height:1.55;">
        <div><b>Base:</b> Sat√©lite (NASA GIBS / VIIRS) <span class="muted">(com fallback)</span></div>
        <div><b>Sobreposi√ß√£o:</b> NDVI (vegeta√ß√£o) <span class="muted">(placeholder)</span></div>
        <div><b>Dist√∫rbios:</b> anomalias t√©rmicas / fogo <span class="muted">(MVP via EONET)</span></div>
        <hr style="border:0; border-top:1px solid var(--line2); margin:10px 0;">
        <div><b>Pontos (reais):</b></div>
        <div class="muted">Eventos p√∫blicos de inc√™ndio (NASA EONET), filtrados para regi√£o amaz√¥nica.</div>
        <div style="margin-top:10px;" class="muted">
          Atualiza√ß√£o: <span id="lastUpdate">‚Äî</span>
        </div>
      </div>
    </div>

    <div class="card mapwrap">
      <div id="map"></div>
      <div class="mapHUD"></div>

      <div class="statusBox">
        <div class="statusLine">
          <span id="statusDot" class="dot"></span>
          <span><span id="statusOnline">carregando</span> ‚Äî Amaz√¥nia</span>
        </div>
        <div style="font-size:12px; color: rgba(228,233,242,.8);">
          BioIndex: <b><span id="bioIndex">‚Äî</span></b> <span class="muted">(MVP)</span><br>
          Dados p√∫blicos carregados. Clique nos pontos.
        </div>
      </div>

      <div class="legendBox">
        <div class="legendTitle">√çndice Ecol√≥gico Amaz√¥nico (0‚Äì100)</div>
        <div class="bar"></div>
        <div class="legendRow">
          <span>impacto</span><span>alerta</span><span>baixo dist√∫rbio</span>
        </div>
      </div>
    </div>

    <div class="card right">
      <h3>üì° Leituras em tempo real <span class="muted"><span id="qtdPontos">0</span> pontos</span></h3>
      <div style="font-size:12px; line-height:1.55;">
        <div><b>Resumo</b></div>
        <div class="muted">
          Pontos = eventos p√∫blicos (inc√™ndios). Cor = regra do Observat√≥rio:
          <b style="color:var(--danger)">vermelho</b> dist√∫rbio ‚Ä¢
          <b style="color:var(--warn)">amarelo</b> alerta ‚Ä¢
          <b style="color:var(--ok)">verde</b> sem dist√∫rbio.
        </div>
        <hr style="border:0; border-top:1px solid var(--line2); margin:10px 0;">
        <div><b>√öltimo ponto selecionado</b></div>
        <div class="muted" id="ultimoPonto">‚Äî</div>
      </div>
    </div>

    <div class="card bottomA">
      <h3>üìà S√©rie temporal (MVP) <span class="muted">espa√ßo reservado</span></h3>
      <div class="muted" style="font-size:12px; line-height:1.55;">
        Pr√≥ximo passo: gr√°fico real do √≠ndice (NDVI + fogo + clima) por dia/semana.
      </div>
    </div>

    <div class="card bottomB">
      <h3>üß¨ Integridade / Cobertura <span class="muted">espa√ßo reservado</span></h3>
      <div class="muted" style="font-size:12px; line-height:1.55;">
        Pr√≥ximo passo: m√©tricas por sat√©lite (NDVI/biomassa) e mudan√ßas de cobertura.
      </div>
    </div>

    <div class="card bottomC">
      <h3>üîí Transpar√™ncia <span class="muted">jur√≠dico</span></h3>
      <div class="muted" style="font-size:12px; line-height:1.55;">
        Observat√≥rio Amaz√¥nia ‚Äî Transpar√™ncia ambiental baseada em dados p√∫blicos.<br>
        Este projeto n√£o constitui oferta de investimento. Plataforma de monitoramento ambiental.
      </div>
    </div>

  </div>

  <!-- MODAL -->
  <div class="modalOverlay" id="modalOverlay" onclick="overlayClick(event)">
    <div class="modal">
      <div class="modalTop">
        <div class="modalTitle" id="modalTitle"></div>
        <div class="close" onclick="closeModal()">Fechar ‚úï</div>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ====== MAPA ======
    const map = L.map("map", {
      zoomControl: true,
      attributionControl: true
    });

    // Foco Amaz√¥nia (aprox.)
    map.setView([-5.5, -60.0], 4);

    // NASA GIBS VIIRS True Color (GoogleMapsCompatible)
    function utcTodayYYYYMMDD(){
      const d = new Date();
      const yyyy = d.getUTCFullYear();
      const mm = String(d.getUTCMonth()+1).padStart(2,"0");
      const dd = String(d.getUTCDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    const day = utcTodayYYYYMMDD();

    const gibs = L.tileLayer(
      `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_SNPP_CorrectedReflectance_TrueColor/default/${day}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg`,
      { maxZoom: 9, attribution: "NASA GIBS (VIIRS)" }
    );

    const esriFallback = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 18, attribution: "Esri World Imagery" }
    );

    // tenta GIBS, se falhar, usa Esri
    let baseOk = false;
    gibs.on("tileerror", ()=> {
      if(!baseOk){
        map.removeLayer(gibs);
        esriFallback.addTo(map);
        baseOk = true;
      }
    });
    gibs.on("load", ()=> { baseOk = true; });
    gibs.addTo(map);

    // Camadas
    const layerPontos = L.layerGroup().addTo(map);

    // HUD status
    function setStatus(ok, txt){
      const dot = document.getElementById("statusDot");
      const s = document.getElementById("statusOnline");
      s.textContent = txt;
      dot.classList.toggle("erro", !ok);
    }

    // ====== REGRA DE COR (sua regra) ======
    // dist√∫rbio real => vermelho
    // alerta => amarelo (MVP: evento mais antigo)
    // sem dist√∫rbio => verde (√°rea sem pontos; ponto verde fica para "pontos de controle")
    function classePorEstado(estado){
      if(estado === "disturbio") return "vermelho";
      if(estado === "alerta") return "amarelo";
      return "verde";
    }

    function criarMarcadorHolo(lat, lon, estado, popupHTML){
      const classe = classePorEstado(estado);

      const icon = L.divIcon({
        className:"",
        html:`<div class="ponto ${classe}"></div>`,
        iconSize:[22,22],
        iconAnchor:[11,11]
      });

      const m = L.marker([lat, lon], { icon }).addTo(layerPontos);
      m.bindPopup(popupHTML);

      m.on("click", ()=>{
        document.getElementById("ultimoPonto").innerHTML = popupHTML;
      });

      return m;
    }

    function limparPontos(){
      layerPontos.clearLayers();
      document.getElementById("qtdPontos").textContent = "0";
    }

    // ====== EONET (PONTOS REAIS) ======
    // MVP: puxa inc√™ndios (wildfires) dos √∫ltimos 30 dias.
    // cor:
    //   - se evento √© recente (<= 7 dias): dist√∫rbio => vermelho
    //   - se mais antigo: alerta => amarelo
    function diasDesde(dataISO){
      const t = new Date(dataISO).getTime();
      if(isNaN(t)) return 999;
      const now = Date.now();
      return Math.floor((now - t) / (1000*60*60*24));
    }

    // Bounding box aproximada ‚ÄúAmaz√¥nia‚Äù (MVP). Ajustamos depois com pol√≠gono oficial.
    const AMAZON_BBOX = {
      minLat: -20, maxLat: 8,
      minLon: -80, maxLon: -45
    };
    function dentroAmazonia(lat, lon){
      return (
        lat >= AMAZON_BBOX.minLat && lat <= AMAZON_BBOX.maxLat &&
        lon >= AMAZON_BBOX.minLon && lon <= AMAZON_BBOX.maxLon
      );
    }

    async function carregarPontosEONET(){
      // EONET v3
      const url = "https://eonet.gsfc.nasa.gov/api/v3/events?category=wildfires&days=30&status=open";
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("EONET falhou (" + res.status + ")");

      const json = await res.json();
      const events = json.events || [];

      let count = 0;
      let somaBio = 0;

      for(const ev of events){
        // pega √∫ltima geometria com coord
        const geoms = ev.geometry || [];
        if(!geoms.length) continue;

        const g = geoms[geoms.length - 1];
        const coords = g.coordinates; // [lon, lat]
        if(!coords || coords.length < 2) continue;

        const lon = coords[0];
        const lat = coords[1];

        if(!dentroAmazonia(lat, lon)) continue;

        const dISO = g.date || ev.updated || ev.created || "";
        const dd = diasDesde(dISO);

        // MVP de ALERTA vs DIST√öRBIO:
        // - dist√∫rbio = evento recente (<=7 dias) => vermelho
        // - alerta = evento mais antigo => amarelo
        const estado = (dd <= 7) ? "disturbio" : "alerta";

        // BioIndex MVP: s√≥ para mostrar n√∫mero (n√£o √© ‚Äúverdade cient√≠fica‚Äù ainda)
        // (dist√∫rbio puxa para baixo, alerta meio termo)
        const valor = (estado === "disturbio") ? 25 : 55;
        somaBio += valor;

        const popup = `
          <b>${ev.title || "Evento"}</b><br>
          <span class="muted">Fonte:</span> NASA EONET (wildfires)<br>
          <span class="muted">Classifica√ß√£o:</span> <b>${estado === "disturbio" ? "impacto" : "alerta"}</b><br>
          <span class="muted">Data:</span> ${dISO || "‚Äî"}<br>
          <span class="muted">Lat/Lon:</span> ${lat.toFixed(3)} | ${lon.toFixed(3)}
        `;

        criarMarcadorHolo(lat, lon, estado, popup);
        count++;
      }

      document.getElementById("qtdPontos").textContent = String(count);

      if(count > 0){
        const media = Math.round(somaBio / count);
        document.getElementById("bioIndex").textContent = String(media) + " (MVP)";
      }else{
        document.getElementById("bioIndex").textContent = "‚Äî";
      }
    }

    async function atualizarTudo(){
      try{
        setStatus(false, "atualizando");
        limparPontos();

        await carregarPontosEONET();

        const now = new Date();
        const fmt = now.toLocaleString("pt-BR");
        document.getElementById("lastUpdate").textContent = fmt;

        setStatus(true, "Sistema ativo");
      }catch(err){
        setStatus(false, "erro");
        alert("Erro ao atualizar: " + err.message);
      }
    }

    // ===== MODAIS =====
    const content = {
      oquee: {
        title: "üåø O que √© o Observat√≥rio Bioecol√≥gico da Amaz√¥nia",
        body: `
          <p>
            Um painel p√∫blico que transforma <b>dados ambientais reais</b> em uma leitura visual do
            estado ecol√≥gico da floresta.
          </p>
          <p class="muted">
            Sem pre√ßo, sem promessa, sem venda: apenas monitoramento verific√°vel.
          </p>
        `
      },
      comofunciona: {
        title: "‚öôÔ∏è Como funciona (MVP)",
        body: `
          <ul class="bullet">
            <li><b>Sat√©lite real</b> (NASA GIBS / VIIRS) como base do mapa.</li>
            <li><b>Vegeta√ß√£o</b> (NDVI) como camada bi√≥tica <span class="muted">(pr√≥ximo passo)</span>.</li>
            <li><b>Dist√∫rbios</b> (anomalias t√©rmicas/fogo) <span class="muted">(MVP via EONET)</span>.</li>
            <li><b>Pontos reais</b> de inc√™ndio via NASA EONET (√∫ltimos 30 dias).</li>
          </ul>
          <p class="muted">
            Regra do Observat√≥rio: <b>dist√∫rbio</b> = üî¥ ‚Ä¢ <b>alerta</b> = üü° ‚Ä¢ <b>sem dist√∫rbio</b> = üü¢.
            No MVP atual, o ‚Äúalerta‚Äù √© definido por rec√™ncia (evento mais antigo).
          </p>
        `
      },
      painel: {
        title: "üìä Painel Amaz√¥nia ‚Äî voc√™ encontra",
        body: `
          <ul class="bullet">
            <li><b>Sistema ativo da Amaz√¥nia</b></li>
            <li><b>Dados p√∫blicos</b></li>
            <li><b>Atualiza√ß√£o cont√≠nua</b></li>
          </ul>
          <p class="muted">
            Mapa sat√©lite real + camadas + pontos hologr√°ficos reais (EONET). Clique nos pontos para ver fonte e data.
          </p>
        `
      }
    };

    function openModal(key){
      const overlay = document.getElementById("modalOverlay");
      const titleEl = document.getElementById("modalTitle");
      const bodyEl = document.getElementById("modalBody");
      const item = content[key];
      if(!item) return;
      titleEl.innerHTML = item.title;
      bodyEl.innerHTML = item.body;
      overlay.style.display = "flex";
    }
    function closeModal(){ document.getElementById("modalOverlay").style.display = "none"; }
    function overlayClick(e){ if(e.target.id === "modalOverlay") closeModal(); }
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

    // start
    atualizarTudo();
    setInterval(atualizarTudo, 10 * 60 * 1000);
  </script>
</body>
</html>
