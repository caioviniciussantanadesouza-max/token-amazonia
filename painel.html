<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Painel Amaz√¥nia ‚Äî Observat√≥rio Bioecol√≥gico</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    :root{
      --bg:#05080f;
      --panel: rgba(6,10,18,.82);
      --line: rgba(26,255,140,.25);
      --neon:#1aff8c;
      --text:#e4e9f2;
      --muted:#9bb0d3;
      --red:#ff3b3b;
      --yellow:#ffd24d;
      --green:#1aff8c;
      --blue:#33b6ff;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family: Arial, Helvetica, sans-serif; overflow:hidden; }

    .topbar{
      position:fixed; top:10px; left:10px; right:10px; z-index:9999;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 12px; border:1px solid var(--line); background:var(--panel);
      border-radius:16px; backdrop-filter: blur(10px);
    }
    .brand{ font-weight:900; letter-spacing:.3px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .brand small{ color:rgba(228,233,242,.75); font-weight:700; }
    .tag{ font-size:.85em; padding:4px 8px; border:1px solid var(--line); border-radius:999px; background:rgba(0,0,0,.25); }
    .chips{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .chip{
      display:flex; align-items:center; gap:8px; padding:10px 14px;
      border:1px solid var(--line); border-radius:999px; cursor:pointer;
      background: rgba(0,0,0,.25); font-weight:900; user-select:none; white-space:nowrap;
      transition:.2s;
    }
    .chip:hover{ border-color: rgba(26,255,140,.55); box-shadow:0 0 18px rgba(26,255,140,.12); }
    .chip.on{ border-color: rgba(26,255,140,.70); box-shadow:0 0 18px rgba(26,255,140,.16); color:var(--neon); }

    .actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .btn{
      padding:10px 14px; border:1px solid var(--line); background:rgba(0,0,0,.25);
      color:var(--text); border-radius:999px; cursor:pointer; font-weight:900;
    }
    .btn.primary{ border-color: rgba(26,255,140,.55); color:var(--neon); }
    .btn:hover{ box-shadow:0 0 18px rgba(26,255,140,.12); border-color: rgba(26,255,140,.55); }

    .grid{
      position:fixed; inset:70px 10px 10px 10px;
      display:grid; grid-template-columns: 330px 1fr 330px; grid-template-rows: 1fr 180px;
      gap:10px;
    }
    .panel{
      border:1px solid var(--line); background:var(--panel); border-radius:16px;
      backdrop-filter: blur(10px); padding:12px; overflow:hidden;
    }
    .left{ grid-column:1; grid-row:1; }
    .mapWrap{ grid-column:2; grid-row:1; position:relative; }
    .right{ grid-column:3; grid-row:1; }
    .bottomL{ grid-column:1; grid-row:2; }
    .bottomM{ grid-column:2; grid-row:2; }
    .bottomR{ grid-column:3; grid-row:2; }

    #map{ position:absolute; inset:0; border-radius:16px; overflow:hidden; border:1px solid rgba(26,255,140,.20); }
    .hr{ height:1px; background:rgba(26,255,140,.12); margin:10px 0; }
    .muted{ color:var(--muted); }

    .legendDot{ width:10px; height:10px; border-radius:999px; display:inline-block; margin-right:8px; box-shadow:0 0 12px rgba(255,255,255,.12); }

    .hudBox{
      position:absolute; z-index:800; border:1px solid rgba(26,255,140,.22);
      background: rgba(6,10,18,.72); border-radius:12px; padding:10px;
      backdrop-filter: blur(10px); box-shadow:0 10px 30px rgba(0,0,0,.35);
      color:rgba(228,233,242,.92); max-width: 420px;
    }
    .hudTop{ top:10px; left:10px; }
    .hudScale{ left:10px; bottom:10px; min-width: 300px; }
    .scaleBar{
      height:10px; border-radius:999px;
      background: linear-gradient(90deg, var(--red), var(--yellow), var(--green));
      border:1px solid rgba(255,255,255,.08);
      margin-top:8px; overflow:hidden;
    }
    .scaleLabels{ display:flex; justify-content:space-between; font-size:.78em; color:rgba(228,233,242,.70); margin-top:6px; }

    .slider{ width:100%; accent-color: var(--neon); }

    /* Modal */
    .modalOverlay{ position:fixed; inset:0; background: rgba(0,0,0,.70); display:none; align-items:center; justify-content:center; z-index:10000; }
    .modal{ width:min(820px, calc(100vw - 28px)); background: rgba(6,10,18,.90); border:1px solid var(--line);
      border-radius:18px; padding:18px; backdrop-filter: blur(12px); box-shadow:0 10px 40px rgba(0,0,0,.55); }
    .close{ float:right; cursor:pointer; font-weight:900; border:1px solid var(--line); border-radius:999px; padding:6px 10px; }
    .close:hover{ border-color: rgba(26,255,140,.55); }
    .modalTitle{ font-weight:900; font-size:1.1em; }
    .modalBody{ margin-top:10px; line-height:1.6; color:#dfe7ff; }
    ul.bullet{ padding-left:18px; }
    ul.bullet li{ margin:8px 0; }

    @media (max-width: 1100px){
      body{ overflow:auto; }
      .grid{ position:relative; inset:auto; margin-top:80px; grid-template-columns: 1fr; grid-template-rows:auto; height:auto; }
      .left,.mapWrap,.right,.bottomL,.bottomM,.bottomR{ grid-column:1; }
      .mapWrap{ height: 65vh; }
      #map{ position:relative; height:65vh; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      PAINEL AMAZ√îNIA ‚Äî Observat√≥rio Bioecol√≥gico
      <small>Dados p√∫blicos ‚Ä¢ Atualiza√ß√£o cont√≠nua ‚Ä¢ Escala 0‚Äì100</small>
      <span class="tag" id="statusOnline">online</span>
    </div>

    <div class="chips">
      <div class="chip" onclick="openModal('oquee')">üåø O que √©</div>
      <div class="chip" onclick="openModal('comofunciona')">‚öôÔ∏è Como funciona</div>
      <div class="chip" onclick="openModal('painel')">üìä Painel</div>

      <div class="chip" id="tNDVI">üå± NDVI</div>
      <div class="chip" id="tCHUVA">üåßÔ∏è Chuva</div>
      <div class="chip" id="tCALOR">üå°Ô∏è Calor</div>
      <div class="chip" id="tAGUA">üíß √Ågua</div>
      <div class="chip" id="tDESM" title="Toggle pronto (pluga fonte depois)">ü™ì Desmatamento</div>
    </div>

    <div class="actions">
      <button class="btn" onclick="window.location.href='index.html'">‚Üê Voltar</button>
      <button class="btn primary" onclick="atualizarTudo()">‚ü≥ Atualizar</button>
    </div>
  </div>

  <div class="grid">
    <div class="panel left">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-weight:900;">üß≠ Camadas p√∫blicas</div>
        <div class="tag" id="tagConn">online</div>
      </div>
      <div class="hr"></div>

      <div class="muted" style="line-height:1.6;">
        <div><b>Base:</b> Sat√©lite (NASA GIBS / VIIRS)</div>
        <div><b>NDVI:</b> Vegeta√ß√£o (NASA GIBS)</div>
        <div><b>Chuva:</b> GPM IMERG (NASA GIBS)</div>
        <div><b>Calor:</b> LST (NASA GIBS)</div>
        <div><b>√Ågua:</b> Water Mask (NASA GIBS)</div>
        <div><b>Dist√∫rbio:</b> inc√™ndios reais (NASA EONET)</div>
      </div>

      <div class="hr"></div>

      <div style="font-weight:900; margin-bottom:6px;">Regra (MVP)</div>
      <div class="muted" style="line-height:1.9;">
        <span class="legendDot" style="background:var(--green)"></span> sem dist√∫rbio<br/>
        <span class="legendDot" style="background:var(--yellow)"></span> alerta<br/>
        <span class="legendDot" style="background:var(--red)"></span> dist√∫rbio (evento real)
      </div>

      <div class="hr"></div>

      <div class="muted" style="font-size:.92em; line-height:1.6;">
        <div><b>Atualiza√ß√£o:</b> <span id="tsUpdate">‚Äî</span></div>
        <div><b>Inc√™ndios (EONET) no bioma:</b> <span id="countEvents">‚Äî</span></div>
        <div><b>HEX (pixels):</b> <span id="countHex">‚Äî</span></div>
      </div>

      <div class="hr"></div>

      <div style="font-weight:900; margin-bottom:8px;">Densidade (holograma)</div>
      <input class="slider" id="density" type="range" min="10" max="30" value="18" />
      <div class="muted" style="font-size:.86em; margin-top:6px;">
        Menor = mais detalhado (pesa mais). Recomendado: 16‚Äì22.
      </div>
    </div>

    <div class="panel mapWrap">
      <div id="map"></div>

      <div class="hudBox hudTop">
        <div style="font-weight:900;">‚úÖ Sistema ativo ‚Äî Amaz√¥nia</div>
        <div class="muted" style="margin-top:4px; font-size:.92em;">
          ‚ÄúAmaz√¥nia hologr√°fica‚Äù: grade HEX recortada no bioma, colorida por dist√∫rbio real (EONET) + camadas p√∫blicas.
        </div>
      </div>

      <div class="hudBox hudScale">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
          <div style="font-weight:900;">√çndice Ecol√≥gico Amaz√¥nico (0‚Äì100)</div>
          <div class="tag">MVP</div>
        </div>
        <div class="scaleBar"></div>
        <div class="scaleLabels">
          <span>impacto</span><span>alerta</span><span>baixo dist√∫rbio</span>
        </div>
      </div>
    </div>

    <div class="panel right">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-weight:900;">üì° Leituras</div>
        <div class="tag"><span id="liveCount">‚Äî</span> hex</div>
      </div>
      <div class="hr"></div>
      <div class="muted" style="font-size:.92em; line-height:1.6;">
        Clique em um hex para ver a classifica√ß√£o e a dist√¢ncia do dist√∫rbio real (EONET).
      </div>
      <div class="hr"></div>
      <div style="font-weight:900; margin-bottom:8px;">√öltima leitura</div>
      <div class="muted" id="lastPick">‚Äî</div>
    </div>

    <div class="panel bottomL">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-weight:900;">üìà S√©rie temporal</div>
        <div class="tag">placeholder</div>
      </div>
      <div class="hr"></div>
      <div class="muted">
        Pr√≥ximo passo: s√©rie temporal real (NDVI + fogo + chuva + calor + desmatamento).
      </div>
    </div>

    <div class="panel bottomM">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-weight:900;">üß¨ Integridade / Cobertura</div>
        <div class="tag">placeholder</div>
      </div>
      <div class="hr"></div>
      <div class="muted">
        Pr√≥ximo passo: desmatamento/alertas oficiais + mudan√ßa de cobertura + biomassa.
      </div>
    </div>

    <div class="panel bottomR">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-weight:900;">üîí Transpar√™ncia</div>
        <div class="tag">jur√≠dico</div>
      </div>
      <div class="hr"></div>
      <div class="muted">
        Observat√≥rio Amaz√¥nia ‚Äî Transpar√™ncia ambiental baseada em dados p√∫blicos.<br/>
        Este projeto n√£o constitui oferta de investimento. Plataforma de monitoramento ambiental.
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modalOverlay" id="modalOverlay" onclick="overlayClick(event)">
    <div class="modal">
      <div class="close" onclick="closeModal()">Fechar ‚úï</div>
      <div class="modalTitle" id="modalTitle"></div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ==============================
    // ARQUIVOS LOCAIS (repo)
    // ==============================
    const GEOJSON_URL = "amz.geojson"; // SEM acento. Nome tem que existir no GitHub.

    // ==============================
    // DADOS REAIS (APIs)
    // ==============================
    const EONET_WILDFIRES = "https://eonet.gsfc.nasa.gov/api/v3/events?status=open&category=wildfires&days=30";

    // ==============================
    // REGRAS MVP (dist√¢ncia ao dist√∫rbio real)
    // ==============================
    const TH_RED_KM = 70;     // perto do dist√∫rbio real = vermelho
    const TH_YELLOW_KM = 170; // intermedi√°rio = amarelo

    // ==============================
    // NASA GIBS (tiles p√∫blicos)
    // ==============================
    // Base sat√©lite real (VIIRS TrueColor)
    const L_BASE = L.tileLayer(
      "https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_SNPP_CorrectedReflectance_TrueColor/default/2019-01-01/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg",
      { maxZoom: 9, attribution: "Leaflet | NASA GIBS (VIIRS)" }
    );

    // NDVI real
    const L_NDVI = L.tileLayer(
      "https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_NDVI_16Day/default/2019-01-01/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png",
      { maxZoom: 9, opacity: 0.55, attribution: "NASA GIBS (NDVI)" }
    );

    // Chuva real (GPM IMERG) ‚Äî visual (acumulado)
    const L_CHUVA = L.tileLayer(
      "https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/IMERG_Precipitation_Rate/default/2019-01-01/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png",
      { maxZoom: 9, opacity: 0.45, attribution: "NASA GIBS (GPM IMERG)" }
    );

    // Calor real (LST) ‚Äî estresse t√©rmico (visual)
    const L_CALOR = L.tileLayer(
      "https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_Land_Surface_Temp_Day/default/2019-01-01/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png",
      { maxZoom: 9, opacity: 0.45, attribution: "NASA GIBS (LST)" }
    );

    // √Ågua real (water mask) ‚Äî azul
    const L_AGUA = L.tileLayer(
      "https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Combined_Water_Mask/default/2019-01-01/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png",
      { maxZoom: 9, opacity: 0.55, attribution: "NASA GIBS (Water Mask)" }
    );

    // ==============================
    // MAP INIT
    // ==============================
    const map = L.map("map", { zoomControl:true, preferCanvas:true });
    L_BASE.addTo(map);
    map.setView([-5.5, -62], 4);

    // ==============================
    // STATE
    // ==============================
    let amazoniaFeature = null;
    let eonetEvents = [];
    const layerEvents = L.layerGroup().addTo(map);
    const layerHUD = L.layerGroup().addTo(map);
    const layerHex = L.layerGroup().addTo(map);

    // toggles
    const toggles = {
      ndvi: false,
      chuva: false,
      calor: false,
      agua: false,
      desm: false // pronto, mas sem fonte plugada
    };

    // ==============================
    // UI helpers
    // ==============================
    const $ = (id)=>document.getElementById(id);

    function setChip(el, on){
      if(on) el.classList.add("on"); else el.classList.remove("on");
    }

    // Toggle handlers
    $("tNDVI").onclick = ()=>{ toggles.ndvi = !toggles.ndvi; toggles.ndvi ? L_NDVI.addTo(map) : map.removeLayer(L_NDVI); setChip($("tNDVI"), toggles.ndvi); };
    $("tCHUVA").onclick = ()=>{ toggles.chuva = !toggles.chuva; toggles.chuva ? L_CHUVA.addTo(map) : map.removeLayer(L_CHUVA); setChip($("tCHUVA"), toggles.chuva); };
    $("tCALOR").onclick = ()=>{ toggles.calor = !toggles.calor; toggles.calor ? L_CALOR.addTo(map) : map.removeLayer(L_CALOR); setChip($("tCALOR"), toggles.calor); };
    $("tAGUA").onclick = ()=>{ toggles.agua = !toggles.agua; toggles.agua ? L_AGUA.addTo(map) : map.removeLayer(L_AGUA); setChip($("tAGUA"), toggles.agua); };

    // Desmatamento: toggle ‚Äúpronto‚Äù, mas sem endpoint. Mant√©m UI coerente sem quebrar.
    $("tDESM").onclick = ()=>{
      toggles.desm = !toggles.desm;
      setChip($("tDESM"), toggles.desm);
      if(toggles.desm){
        alert("Desmatamento: toggle pronto. Para ligar com dado real (DETER/GFW), precisa plugar o tile/API. O resto do painel j√° est√° real e rodando.");
      }
    };

    $("density").addEventListener("input", ()=> desenharHex());

    // ==============================
    // Colors / score
    // ==============================
    function classificarPorDistKm(distKm){
      if(distKm <= TH_RED_KM) return "vermelho";
      if(distKm <= TH_YELLOW_KM) return "amarelo";
      return "verde";
    }
    function corDaClasse(cls){
      if(cls==="vermelho") return getComputedStyle(document.documentElement).getPropertyValue("--red").trim();
      if(cls==="amarelo") return getComputedStyle(document.documentElement).getPropertyValue("--yellow").trim();
      return getComputedStyle(document.documentElement).getPropertyValue("--green").trim();
    }
    function scoreDaClasse(cls){
      if(cls==="vermelho") return 20;
      if(cls==="amarelo") return 55;
      return 85;
    }

    // haversine km
    function distKm(aLat,aLon,bLat,bLon){
      const R=6371;
      const dLat=(bLat-aLat)*Math.PI/180;
      const dLon=(bLon-aLon)*Math.PI/180;
      const lat1=aLat*Math.PI/180;
      const lat2=bLat*Math.PI/180;
      const x=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(x));
    }
    function distMinimaEventos(lat, lon){
      if(!eonetEvents.length) return Infinity;
      let min = Infinity;
      for(const ev of eonetEvents){
        const d = distKm(lat, lon, ev.lat, ev.lon);
        if(d < min) min = d;
      }
      return min;
    }

    // ==============================
    // Load GeoJSON + fit bounds
    // ==============================
    async function carregarGeojson(){
      const res = await fetch(GEOJSON_URL, { cache:"no-store" });
      if(!res.ok) throw new Error("Nao achei "+GEOJSON_URL+" (erro "+res.status+"). Confere o nome no GitHub.");
      const gj = await res.json();
      amazoniaFeature = (gj.type==="Feature") ? gj : (gj.features ? gj.features[0] : null);
      if(!amazoniaFeature) throw new Error("GeoJSON invalido (sem Feature).");

      const bbox = turf.bbox(amazoniaFeature);
      const bounds = L.latLngBounds([bbox[1], bbox[0]], [bbox[3], bbox[2]]);
      map.fitBounds(bounds.pad(0.12));

      // contorno HUD (fino)
      L.geoJSON(amazoniaFeature, {
        style: { color:"rgba(26,255,140,.60)", weight:2, fillColor:"rgba(26,255,140,.05)", fillOpacity:0.06 }
      }).addTo(layerHUD);
    }

    // ==============================
    // Load EONET (fires) real
    // ==============================
    async function carregarEonet(){
      const res = await fetch(EONET_WILDFIRES, { cache:"no-store" });
      if(!res.ok) throw new Error("EONET falhou (erro "+res.status+")");
      const data = await res.json();

      const all = [];
      for(const ev of (data.events||[])){
        const geo = (ev.geometry && ev.geometry.length) ? ev.geometry[ev.geometry.length-1] : null;
        if(!geo || geo.type !== "Point") continue;
        const [lon, lat] = geo.coordinates;
        all.push({ lat, lon, title: ev.title || "Wildfire", dateISO: geo.date || ev.updated || "" });
      }

      // filtra dentro do bioma
      const poly = amazoniaFeature;
      const bbox = turf.bbox(poly);
      const filtered = [];
      for(const e of all){
        if(e.lon < bbox[0] || e.lon > bbox[2] || e.lat < bbox[1] || e.lat > bbox[3]) continue;
        if(turf.booleanPointInPolygon(turf.point([e.lon,e.lat]), poly)) filtered.push(e);
      }
      eonetEvents = filtered;

      layerEvents.clearLayers();
      const cRed = getComputedStyle(document.documentElement).getPropertyValue("--red").trim();

      for(const ev of eonetEvents){
        const halo = L.circleMarker([ev.lat, ev.lon], { radius:16, color:cRed, weight:0, fillColor:cRed, fillOpacity:0.16 });
        const dot  = L.circleMarker([ev.lat, ev.lon], { radius:5,  color:cRed, weight:2, fillColor:cRed, fillOpacity:0.80 });

        dot.bindPopup(`
          <div style="font-weight:900;margin-bottom:6px;">üî• Disturbio real (EONET)</div>
          <div><b>${ev.title}</b></div>
          <div class="muted" style="margin-top:6px;">Data: ${String(ev.dateISO).slice(0,19).replace("T"," ")}</div>
          <div class="muted">Lat: ${ev.lat.toFixed(3)} | Lon: ${ev.lon.toFixed(3)}</div>
        `);

        halo.addTo(layerEvents);
        dot.addTo(layerEvents);
      }

      $("countEvents").textContent = String(eonetEvents.length);
    }

    // ==============================
    // HOLOGRAMA: grade HEX recortada
    // ==============================
    function desenharHex(){
      if(!amazoniaFeature) return;
      layerHex.clearLayers();

      const density = Number($("density").value); // 10..30
      // cellSide em km: maior = menos hex; menor = mais hex
      const cellSideKm = Math.max(18, Math.min(60, density * 2)); // 20..60km aprox (equilibrado)

      const bbox = turf.bbox(amazoniaFeature);
      const bboxPoly = turf.bboxPolygon(bbox);

      // hexGrid + clip
      const grid = turf.hexGrid(bbox, cellSideKm, { units:"kilometers" });

      let count = 0;
      for(const f of grid.features){
        // pega centro do hex e testa se est√° dentro do bioma
        const center = turf.center(f);
        if(!turf.booleanPointInPolygon(center, amazoniaFeature)) continue;

        const [lon, lat] = center.geometry.coordinates;
        const d = distMinimaEventos(lat, lon);
        const cls = classificarPorDistKm(d);
        const c = corDaClasse(cls);
        const score = scoreDaClasse(cls);

        // hex estilo ‚Äúpixel hologr√°fico‚Äù
        const hex = L.geoJSON(f, {
          style: {
            color: c,
            weight: 0.6,
            fillColor: c,
            fillOpacity: 0.22
          }
        });

        // ‚Äúglow‚Äù discreto (halo)
        const halo = L.circleMarker([lat, lon], {
          radius: 10,
          color: c,
          weight: 0,
          fillColor: c,
          fillOpacity: 0.10
        });

        hex.on("click", ()=>{
          const txt = (cls==="vermelho")?"disturbio":(cls==="amarelo"?"alerta":"sem disturbio");
          $("lastPick").innerHTML =
            `<b>Classificacao:</b> <span style="color:${c};font-weight:900;">${txt}</span><br>` +
            `<b>Distancia ao disturbio real:</b> ${isFinite(d) ? d.toFixed(1)+" km" : "‚Äî"}<br>` +
            `<b>Indice (MVP):</b> ${score}/100<br>` +
            `<span class="muted">Lat: ${lat.toFixed(3)} | Lon: ${lon.toFixed(3)}</span>`;
        });

        halo.addTo(layerHex);
        hex.addTo(layerHex);
        count++;
      }

      $("countHex").textContent = String(count);
      $("liveCount").textContent = String(count);
    }

    // ==============================
    // MODAIS
    // ==============================
    const content = {
      oquee: {
        title: "üåø O que √© o Observat√≥rio Bioecol√≥gico da Amaz√¥nia",
        body: `
          <p>Um painel p√∫blico que transforma <b>dados ambientais reais</b> em uma leitura visual do estado ecol√≥gico da floresta.</p>
          <p class="muted">Sem pre√ßo, sem promessa, sem venda: apenas monitoramento verific√°vel.</p>
        `
      },
      comofunciona: {
        title: "‚öôÔ∏è Como funciona (MVP)",
        body: `
          <ul class="bullet">
            <li><b>Base sat√©lite real</b> (NASA GIBS / VIIRS)</li>
            <li><b>NDVI real</b> (vegeta√ß√£o)</li>
            <li><b>Chuva real</b> (GPM IMERG)</li>
            <li><b>Calor real</b> (LST)</li>
            <li><b>√Ågua real</b> (Water Mask)</li>
            <li><b>Dist√∫rbios reais</b> (inc√™ndios via NASA EONET)</li>
            <li><b>Camada hologr√°fica</b> (grade HEX recortada no bioma)</li>
          </ul>
          <p class="muted">
            Regra do Observat√≥rio: <b>dist√∫rbio</b> = üî¥ ‚Ä¢ <b>alerta</b> = üü° ‚Ä¢ <b>sem dist√∫rbio</b> = üü¢.
            No MVP atual, a cor √© definida pela <b>dist√¢ncia ao dist√∫rbio real</b> (EONET) mais pr√≥ximo.
          </p>
        `
      },
      painel: {
        title: "üìä Painel Amaz√¥nia ‚Äî voc√™ encontra",
        body: `
          <ul class="bullet">
            <li><b>Sistema ativo da Amaz√¥nia</b></li>
            <li><b>Dados p√∫blicos</b></li>
            <li><b>Atualiza√ß√£o cont√≠nua</b></li>
          </ul>
          <p class="muted">Mapa sat√©lite real + camadas (NDVI/chuva/calor/√°gua) + dist√∫rbios reais (EONET) + holograma HEX.</p>
        `
      }
    };

    function openModal(key){
      const overlay = $("modalOverlay");
      $("modalTitle").innerHTML = content[key].title;
      $("modalBody").innerHTML = content[key].body;
      overlay.style.display = "flex";
    }
    function closeModal(){ $("modalOverlay").style.display = "none"; }
    function overlayClick(e){ if(e.target.id === "modalOverlay") closeModal(); }
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });

    // ==============================
    // MAIN UPDATE
    // ==============================
    async function atualizarTudo(){
      try{
        $("statusOnline").textContent = "atualizando";
        $("tagConn").textContent = "online";
        $("tsUpdate").textContent = new Date().toLocaleString("pt-BR");

        // carrega uma vez
        if(!amazoniaFeature){
          layerHUD.clearLayers();
          await carregarGeojson();
        }

        await carregarEonet();
        desenharHex();

        $("statusOnline").textContent = "online";
      }catch(err){
        console.error(err);
        $("statusOnline").textContent = "erro";
        $("tagConn").textContent = "erro";
        alert("Erro ao atualizar: " + err.message);
      }
    }

    // start
    atualizarTudo();
    setInterval(atualizarTudo, 10 * 60 * 1000);
  </script>

  <!-- Modal DOM -->
  <script>
    // cria modal (pra manter arquivo √∫nico)
    const modal = document.createElement("div");
    modal.className = "modalOverlay";
    modal.id = "modalOverlay";
    modal.setAttribute("onclick","overlayClick(event)");
    modal.innerHTML = `
      <div class="modal">
        <div class="close" onclick="closeModal()">Fechar ‚úï</div>
        <div class="modalTitle" id="modalTitle"></div>
        <div class="modalBody" id="modalBody"></div>
      </div>
    `;
    document.body.appendChild(modal);
  </script>
</body>
</html>
