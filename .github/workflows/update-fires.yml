name: Update fires.json (NASA FIRMS)

on:
  schedule:
    - cron: "*/30 * * * *"   # a cada 30 min
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate fires.json
        env:
          FIRMS_MAP_KEY: ${{ secrets.FIRMS_MAP_KEY }}
        run: |
          python - << 'PY'
          import os, json, urllib.request, datetime

          key = os.environ.get("FIRMS_MAP_KEY")
          if not key:
            raise SystemExit("Missing FIRMS_MAP_KEY secret in repo settings")

          # BBOX Amazônia (W,S,E,N)
          west, south, east, north = -79.0, -20.0, -44.0, 6.5
          days_back = 2
          dataset = "VIIRS_SNPP_NRT"

          url = f"https://firms.modaps.eosdis.nasa.gov/api/area/csv/{key}/{dataset}/{west},{south},{east},{north}/{days_back}"
          csv = urllib.request.urlopen(url, timeout=60).read().decode("utf-8").strip().splitlines()

          points = []
          if len(csv) >= 2:
            headers = [h.strip().lower() for h in csv[0].split(",")]
            i_lat = headers.index("latitude")
            i_lon = headers.index("longitude")
            # brightness pode ser bright_ti4, bright_ti5, brightness etc
            i_bright = next((i for i,h in enumerate(headers) if "bright" in h), None)
            i_conf = headers.index("confidence") if "confidence" in headers else None

            def classify(conf, bright):
              # conf pode ser "l/n/h" ou número
              c = (str(conf or "")).lower()
              try:
                cn = float(c)
              except:
                cn = None

              conf_high = c in ("h","high") or (cn is not None and cn >= 80)
              conf_med  = c in ("n","nominal") or (cn is not None and 40 <= cn < 80)
              b = float(bright) if bright not in (None,"") else 0.0

              if conf_high or b >= 340: return "red"
              if conf_med  or b >= 320: return "yellow"
              return "green"

            for row in csv[1:]:
              cols = row.split(",")
              lat = float(cols[i_lat]); lon = float(cols[i_lon])
              bright = float(cols[i_bright]) if i_bright is not None and cols[i_bright] else None
              conf = cols[i_conf] if i_conf is not None else None
              level = classify(conf, bright)

              points.append({
                "lat": lat,
                "lon": lon,
                "level": level,
                "brightness": bright,
                "confidence": conf
              })

          out = {
            "updated_at": datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z",
            "source": "NASA FIRMS",
            "dataset": dataset,
            "days_back": 2,
            "points": points
          }

          with open("fires.json","w",encoding="utf-8") as f:
            json.dump(out, f, ensure_ascii=False, indent=2)

          print("Generated fires.json with", len(points), "points")
          PY

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add fires.json
          git commit -m "Update fires.json" || exit 0
          git push
